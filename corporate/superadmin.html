<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Admin - MyMedPH</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0066cc',
                        secondary: '#00cc66',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast { animation: slideIn 0.3s ease-out; }
        .sidebar { transition: transform 0.3s ease-out; }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.active { transform: translateX(0); }
        }
        .nav-btn.active { background-color: rgba(255, 255, 255, 0.1); }
        .section { display: none; }
        .section.active { display: block; }
    </style>
</head>
<body class="bg-gray-100">
    
    <!-- Initial Auth Loading Overlay -->
    <div id="auth-loading" class="fixed inset-0 bg-white z-[200] flex items-center justify-center">
        <div class="text-center">
            <div class="relative w-16 h-16 mx-auto mb-4">
                <div class="absolute inset-0 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
            </div>
            <p class="text-gray-700 font-semibold">Verifying authentication...</p>
        </div>
    </div>
    
    <!-- Top Bar -->
    <div class="bg-white shadow-md sticky top-0 z-40">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center space-x-4">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-700 text-2xl">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="flex items-center space-x-3">
                    <i class="fas fa-heartbeat text-primary text-2xl"></i>
                    <div>
                        <h1 class="text-xl font-bold text-gray-800">MyMedPH</h1>
                        <p class="text-xs text-gray-600">Super Admin Portal</p>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-gray-700 font-semibold hidden md:inline" id="user-name"></span>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
                    <i class="fas fa-sign-out-alt mr-2"></i><span class="hidden md:inline">Logout</span>
                </button>
            </div>
        </div>
    </div>
    
    <div class="flex min-h-screen">
        <!-- Sidebar -->
        <div id="sidebar" class="sidebar fixed md:static inset-y-0 left-0 z-50 w-64 bg-gray-800 text-white md:block min-h-screen overflow-y-auto">
            <nav class="p-4 space-y-2 mt-16 md:mt-4 pb-8">
                <button onclick="showSection('dashboard')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition active">
                    <i class="fas fa-tachometer-alt mr-3"></i> Dashboard
                </button>
                <button onclick="showSection('clinics')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-hospital mr-3"></i> Clinics
                </button>
                <button onclick="showSection('admins')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-user-shield mr-3"></i> Clinic Admins
                </button>
                <button onclick="showSection('doctors')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-user-md mr-3"></i> All Doctors
                </button>
                <button onclick="showSection('staff')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-users mr-3"></i> All Staff
                </button>
                <button onclick="showSection('appointments')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-calendar-check mr-3"></i> All Appointments
                </button>
                <button onclick="showSection('patients')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-user-injured mr-3"></i> Patient Database
                </button>
                <button onclick="showSection('clinic-analytics')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-chart-line mr-3"></i> Clinic Analytics
                </button>
                <button onclick="showSection('patient-analytics')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-user-chart mr-3"></i> Patient Analytics
                </button>
                <button onclick="showSection('analytics')" class="nav-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-700 transition">
                    <i class="fas fa-chart-bar mr-3"></i> System Analytics
                </button>
            </nav>
        </div>
        
        <!-- Main Content -->
        <div class="flex-1 p-6 overflow-y-auto">
            
            <!-- Dashboard Section -->
            <div id="section-dashboard" class="section active">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">System Dashboard</h2>
                
                <!-- Stats Cards -->
                <div class="grid md:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm">Total Clinics</p>
                                <p id="stat-clinics" class="text-4xl font-bold mt-2">0</p>
                            </div>
                            <i class="fas fa-hospital text-blue-200 text-4xl opacity-50"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm">Total Doctors</p>
                                <p id="stat-doctors" class="text-4xl font-bold mt-2">0</p>
                            </div>
                            <i class="fas fa-user-md text-purple-200 text-4xl opacity-50"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm">Total Staff</p>
                                <p id="stat-staff" class="text-4xl font-bold mt-2">0</p>
                            </div>
                            <i class="fas fa-users text-green-200 text-4xl opacity-50"></i>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-100 text-sm">Total Appointments</p>
                                <p id="stat-appointments" class="text-4xl font-bold mt-2">0</p>
                            </div>
                            <i class="fas fa-calendar-check text-orange-200 text-4xl opacity-50"></i>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Clinics -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Clinics</h3>
                    <div id="recent-clinics" class="space-y-2"></div>
                </div>
                
                <!-- Recent Appointments -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Recent Appointments</h3>
                    <div id="recent-appointments" class="space-y-2"></div>
                </div>
            </div>
            
            <!-- Clinics Section -->
            <div id="section-clinics" class="section hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">Clinics Management</h2>
                    <div class="flex space-x-3">
                        <button onclick="loadClinics()" class="bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition font-semibold">
                            <i class="fas fa-sync-alt mr-2"></i> Refresh
                        </button>
                        <button onclick="syncClinicsFromRegistry()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                            <i class="fas fa-sync mr-2"></i> Sync from Registry
                        </button>
                        <button onclick="showAddClinicModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                            <i class="fas fa-plus mr-2"></i> Add Clinic
                        </button>
                    </div>
                </div>
                <div id="clinics-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            
            <!-- Doctors Section -->
            <div id="section-doctors" class="section hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">All Doctors</h2>
                    <div>
                        <select id="filter-clinic-doctors" onchange="loadDoctors()" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">All Clinics</option>
                        </select>
                    </div>
                </div>
                <div id="doctors-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            
            <!-- Staff Section -->
            <div id="section-staff" class="section hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">All Staff</h2>
                    <div>
                        <select id="filter-clinic-staff" onchange="loadStaff()" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">All Clinics</option>
                        </select>
                    </div>
                </div>
                <div id="staff-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </div>
            
            <!-- Appointments Section -->
            <div id="section-appointments" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">All Appointments</h2>
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="grid md:grid-cols-5 gap-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm">Clinic</label>
                            <select id="filter-clinic-apt" onchange="filterAppointments()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">All Clinics</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm">Status</label>
                            <select id="filter-status" onchange="filterAppointments()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <option value="">All Status</option>
                                <option value="booked">Booked</option>
                                <option value="approve">Approve</option>
                                <option value="appointment">Appointment</option>
                                <option value="missed">Missed</option>
                                <option value="cancelled">Cancelled</option>
                                <option value="completed">Completed</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm">Date</label>
                            <input type="date" id="filter-date" onchange="filterAppointments()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2 text-sm">Search</label>
                            <input type="text" id="filter-search" onkeyup="filterAppointments()" placeholder="Patient name..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="flex items-end">
                            <button onclick="clearFilters()" class="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                                <i class="fas fa-times mr-2"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Doctor</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date & Time</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody id="appointments-table-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Patient Database Section -->
            <div id="section-patients" class="section hidden">
                <!-- Patient List View -->
                <div id="patient-list-view">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-3xl font-bold text-gray-800">Patient Database</h2>
                        <button onclick="exportPatients()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                            <i class="fas fa-download mr-2"></i> Export CSV
                        </button>
                    </div>
                    
                    <!-- Search & Filters -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="grid md:grid-cols-4 gap-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2 text-sm">Search</label>
                                <input type="text" id="patient-search" onkeyup="searchPatients()" placeholder="Name, email, phone..." class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2 text-sm">Clinic</label>
                                <select id="patient-filter-clinic" onchange="filterPatients()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All Clinics</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2 text-sm">Status</label>
                                <select id="patient-filter-status" onchange="filterPatients()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="new">New</option>
                                </select>
                            </div>
                            <div class="flex items-end">
                                <button onclick="clearPatientFilters()" class="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                                    <i class="fas fa-times mr-2"></i> Clear
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Patient Table -->
                    <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient ID</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Clinics Visited</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Visits</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Visit</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="patients-table-body" class="divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Patient Profile View (Hidden by default) -->
                <div id="patient-profile-view" class="hidden">
                    <button onclick="closePatientProfile()" class="mb-6 text-purple-600 hover:text-purple-700 font-semibold">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Patient List
                    </button>
                    
                    <!-- Patient Header -->
                    <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl shadow-lg p-8 text-white mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h2 id="profile-patient-name" class="text-3xl font-bold mb-2">Loading...</h2>
                                <p id="profile-patient-id" class="text-lg opacity-90"></p>
                            </div>
                            <div id="profile-patient-status" class="text-right">
                                <!-- Status badge will be inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Patient Tabs -->
                    <div class="bg-white rounded-xl shadow-lg mb-6">
                        <div class="border-b border-gray-200">
                            <nav class="flex flex-wrap space-x-4 px-6" id="patient-tabs">
                                <button onclick="showPatientTab('overview')" class="patient-tab-btn py-4 px-2 border-b-2 border-purple-600 text-purple-600 font-semibold text-sm">
                                    <i class="fas fa-home mr-1"></i>Overview
                                </button>
                                <button onclick="showPatientTab('medical')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-heartbeat mr-1"></i>Medical History
                                </button>
                                <button onclick="showPatientTab('blood')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-tint mr-1"></i>Blood Profile
                                </button>
                                <button onclick="showPatientTab('dental')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-tooth mr-1"></i>Dental Chart
                                </button>
                                <button onclick="showPatientTab('files')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-images mr-1"></i>Files & Images
                                </button>
                                <button onclick="showPatientTab('treatment')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-procedures mr-1"></i>Treatment Plans
                                </button>
                                <button onclick="showPatientTab('forms')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-file-alt mr-1"></i>Forms
                                </button>
                                <button onclick="showPatientTab('visits')" class="patient-tab-btn py-4 px-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700 font-semibold text-sm">
                                    <i class="fas fa-calendar-check mr-1"></i>Visit History
                                </button>
                            </nav>
                        </div>
                    </div>
                    
                    <!-- Tab Content -->
                    <div id="patient-tab-content">
                        <!-- Content will be loaded dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- Clinic Admins Section -->
            <div id="section-admins" class="section hidden">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold text-gray-800">
                        <i class="fas fa-user-shield text-primary mr-2"></i>Clinic Admins
                    </h2>
                    <button onclick="showAddAdminModal()" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                        <i class="fas fa-plus mr-2"></i>Create Admin Account
                    </button>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 rounded">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-blue-600 text-xl mr-3 mt-1"></i>
                        <div>
                            <p class="font-bold text-blue-800 mb-1">About Clinic Admins</p>
                            <p class="text-sm text-blue-700">Clinic admins can manage their assigned clinic only. They can create doctors and staff, manage appointments, and view patients for their clinic.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Admins List -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Admin</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Clinic</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="admins-table-body" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <p>Loading admins...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Clinic Analytics Section -->
            <div id="section-clinic-analytics" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Clinic Performance Analytics</h2>
                
                <!-- Clinic Comparison Table -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Clinic Comparison</h3>
                        <p class="text-sm text-gray-600 mt-1">Click on a clinic to view detailed analytics</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Clinic</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Appointments</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Completion</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patients</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Doctors</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Staff</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clinic-analytics-table" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Detailed Clinic View (Hidden by default) -->
                <div id="clinic-detail-view" class="hidden">
                    <button onclick="closeClinicDetail()" class="mb-4 text-primary hover:underline">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Clinic Comparison
                    </button>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4" id="clinic-detail-name"></h3>
                        
                        <!-- Clinic Stats Grid -->
                        <div class="grid md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-sm text-blue-600 font-semibold">Total Appointments</p>
                                <p id="clinic-total-appts" class="text-3xl font-bold text-blue-700">0</p>
                                <p id="clinic-appts-trend" class="text-xs text-blue-600 mt-1"></p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4">
                                <p class="text-sm text-green-600 font-semibold">Completion Rate</p>
                                <p id="clinic-completion" class="text-3xl font-bold text-green-700">0%</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <p class="text-sm text-purple-600 font-semibold">Total Patients</p>
                                <p id="clinic-patients" class="text-3xl font-bold text-purple-700">0</p>
                                <p id="clinic-patients-trend" class="text-xs text-purple-600 mt-1"></p>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-4">
                                <p class="text-sm text-orange-600 font-semibold">Team Size</p>
                                <p id="clinic-team" class="text-3xl font-bold text-orange-700">0</p>
                                <p id="clinic-team-breakdown" class="text-xs text-orange-600 mt-1"></p>
                            </div>
                        </div>
                        
                        <!-- Appointment Status Breakdown -->
                        <div class="mb-6">
                            <h4 class="font-bold text-gray-800 mb-3">Appointment Status Distribution</h4>
                            <div class="grid grid-cols-2 md:grid-cols-6 gap-3">
                                <div class="bg-blue-50 rounded-lg p-3 text-center">
                                    <p class="text-xs text-blue-600 font-semibold">Booked</p>
                                    <p id="clinic-status-booked" class="text-2xl font-bold text-blue-700">0</p>
                                </div>
                                <div class="bg-purple-50 rounded-lg p-3 text-center">
                                    <p class="text-xs text-purple-600 font-semibold">Approve</p>
                                    <p id="clinic-status-approve" class="text-2xl font-bold text-purple-700">0</p>
                                </div>
                                <div class="bg-green-50 rounded-lg p-3 text-center">
                                    <p class="text-xs text-green-600 font-semibold">Appointment</p>
                                    <p id="clinic-status-appointment" class="text-2xl font-bold text-green-700">0</p>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-3 text-center">
                                    <p class="text-xs text-gray-600 font-semibold">Completed</p>
                                    <p id="clinic-status-completed" class="text-2xl font-bold text-gray-700">0</p>
                                </div>
                                <div class="bg-red-50 rounded-lg p-3 text-center">
                                    <p class="text-xs text-red-600 font-semibold">Cancelled</p>
                                    <p id="clinic-status-cancelled" class="text-2xl font-bold text-red-700">0</p>
                                </div>
                                <div class="bg-orange-50 rounded-lg p-3 text-center">
                                    <p class="text-xs text-orange-600 font-semibold">Missed</p>
                                    <p id="clinic-status-missed" class="text-2xl font-bold text-orange-700">0</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Top Performers -->
                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h4 class="font-bold text-gray-800 mb-3">Top Doctors</h4>
                                <div id="clinic-top-doctors" class="space-y-2"></div>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 mb-3">Most Popular Services</h4>
                                <div id="clinic-top-services" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Patient Analytics Section -->
            <div id="section-patient-analytics" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Patient Analytics</h2>
                
                <!-- Search and Filters -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div class="grid md:grid-cols-3 gap-4">
                        <input type="text" id="patient-search" onkeyup="searchPatientAnalytics()" placeholder="Search by name, phone, or email..." class="px-4 py-2 border border-gray-300 rounded-lg">
                        <select id="patient-clinic-filter" onchange="filterPatientAnalytics()" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">All Clinics</option>
                        </select>
                        <select id="patient-status-filter" onchange="filterPatientAnalytics()" class="px-4 py-2 border border-gray-300 rounded-lg">
                            <option value="">All Status</option>
                            <option value="active">Active (visited in 30 days)</option>
                            <option value="inactive">Inactive (3+ months)</option>
                            <option value="new">New Patients</option>
                        </select>
                    </div>
                </div>
                
                <!-- Patient List -->
                <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
                    <div class="p-6 border-b border-gray-200">
                        <h3 class="text-xl font-bold text-gray-800">Patient Database</h3>
                        <p class="text-sm text-gray-600 mt-1">Click on a patient to view detailed profile</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Patient</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Visits</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Visit</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reliability</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="patient-analytics-table" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Detailed Patient View (Hidden by default) -->
                <div id="patient-detail-view" class="hidden">
                    <button onclick="closePatientDetail()" class="mb-4 text-primary hover:underline">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Patient List
                    </button>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex items-start justify-between mb-6">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800" id="patient-detail-name"></h3>
                                <p class="text-gray-600" id="patient-detail-contact"></p>
                            </div>
                            <div class="text-right">
                                <span id="patient-detail-status-badge" class="px-3 py-1 rounded-full text-sm font-semibold"></span>
                            </div>
                        </div>
                        
                        <!-- Patient Stats Grid -->
                        <div class="grid md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-blue-50 rounded-lg p-4">
                                <p class="text-sm text-blue-600 font-semibold">Total Visits</p>
                                <p id="patient-total-visits" class="text-3xl font-bold text-blue-700">0</p>
                            </div>
                            <div class="bg-green-50 rounded-lg p-4">
                                <p class="text-sm text-green-600 font-semibold">Show-up Rate</p>
                                <p id="patient-reliability" class="text-3xl font-bold text-green-700">0%</p>
                            </div>
                            <div class="bg-purple-50 rounded-lg p-4">
                                <p class="text-sm text-purple-600 font-semibold">Visit Frequency</p>
                                <p id="patient-frequency" class="text-3xl font-bold text-purple-700">0</p>
                                <p class="text-xs text-purple-600 mt-1">days avg</p>
                            </div>
                            <div class="bg-orange-50 rounded-lg p-4">
                                <p class="text-sm text-orange-600 font-semibold">Last Visit</p>
                                <p id="patient-last-visit" class="text-lg font-bold text-orange-700">-</p>
                            </div>
                        </div>
                        
                        <!-- Visit History -->
                        <div class="mb-6">
                            <h4 class="font-bold text-gray-800 mb-3">Visit History</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Date</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Service</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Doctor</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Clinic</th>
                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="patient-visit-history" class="divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Preferences -->
                        <div class="grid md:grid-cols-3 gap-6">
                            <div>
                                <h4 class="font-bold text-gray-800 mb-3">Preferred Doctor</h4>
                                <p id="patient-preferred-doctor" class="text-gray-600">-</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 mb-3">Preferred Clinic</h4>
                                <p id="patient-preferred-clinic" class="text-gray-600">-</p>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800 mb-3">Most Booked Service</h4>
                                <p id="patient-preferred-service" class="text-gray-600">-</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- System Analytics Section -->
            <div id="section-analytics" class="section hidden">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">System Analytics & Reports</h2>
                
                <!-- System Overview Cards -->
                <div class="grid md:grid-cols-5 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-hospital text-3xl opacity-80"></i>
                            <span id="sys-clinics-badge" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full"></span>
                        </div>
                        <p class="text-sm opacity-90 mb-1">Total Clinics</p>
                        <p id="sys-total-clinics" class="text-4xl font-bold">0</p>
                        <p id="sys-clinics-status" class="text-xs opacity-75 mt-1"></p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-user-md text-3xl opacity-80"></i>
                            <span id="sys-doctors-badge" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full"></span>
                        </div>
                        <p class="text-sm opacity-90 mb-1">Total Doctors</p>
                        <p id="sys-total-doctors" class="text-4xl font-bold">0</p>
                        <p id="sys-doctors-status" class="text-xs opacity-75 mt-1"></p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-users text-3xl opacity-80"></i>
                            <span id="sys-staff-badge" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full"></span>
                        </div>
                        <p class="text-sm opacity-90 mb-1">Total Staff</p>
                        <p id="sys-total-staff" class="text-4xl font-bold">0</p>
                        <p id="sys-staff-status" class="text-xs opacity-75 mt-1"></p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-user-injured text-3xl opacity-80"></i>
                            <span id="sys-patients-badge" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full"></span>
                        </div>
                        <p class="text-sm opacity-90 mb-1">Total Patients</p>
                        <p id="sys-total-patients" class="text-4xl font-bold">0</p>
                        <p id="sys-patients-status" class="text-xs opacity-75 mt-1">Unique</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-pink-500 to-pink-600 rounded-xl shadow-lg p-6 text-white">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-calendar-check text-3xl opacity-80"></i>
                            <span id="sys-appts-badge" class="text-xs bg-white bg-opacity-20 px-2 py-1 rounded-full"></span>
                        </div>
                        <p class="text-sm opacity-90 mb-1">Total Appointments</p>
                        <p id="sys-total-appointments" class="text-4xl font-bold">0</p>
                        <p id="sys-appts-status" class="text-xs opacity-75 mt-1">All time</p>
                    </div>
                </div>
                
                <!-- Performance Metrics -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Performance Metrics</h3>
                    <div class="grid md:grid-cols-4 gap-6">
                        <div class="text-center">
                            <div class="w-24 h-24 mx-auto mb-3 relative">
                                <svg class="transform -rotate-90 w-24 h-24">
                                    <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none" />
                                    <circle id="completion-circle" cx="48" cy="48" r="40" stroke="#10b981" stroke-width="8" fill="none" 
                                        stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="completion-rate" class="text-2xl font-bold text-gray-800">0%</span>
                                </div>
                            </div>
                            <p class="text-gray-600 font-semibold">Completion Rate</p>
                            <p class="text-xs text-gray-500 mt-1">Completed appointments</p>
                        </div>
                        
                        <div class="text-center">
                            <div class="w-24 h-24 mx-auto mb-3 relative">
                                <svg class="transform -rotate-90 w-24 h-24">
                                    <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none" />
                                    <circle id="cancellation-circle" cx="48" cy="48" r="40" stroke="#ef4444" stroke-width="8" fill="none" 
                                        stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="cancellation-rate" class="text-2xl font-bold text-gray-800">0%</span>
                                </div>
                            </div>
                            <p class="text-gray-600 font-semibold">Cancellation Rate</p>
                            <p class="text-xs text-gray-500 mt-1">Cancelled appointments</p>
                        </div>
                        
                        <div class="text-center">
                            <div class="w-24 h-24 mx-auto mb-3 relative">
                                <svg class="transform -rotate-90 w-24 h-24">
                                    <circle cx="48" cy="48" r="40" stroke="#e5e7eb" stroke-width="8" fill="none" />
                                    <circle id="noshow-circle" cx="48" cy="48" r="40" stroke="#f59e0b" stroke-width="8" fill="none" 
                                        stroke-dasharray="251.2" stroke-dashoffset="251.2" stroke-linecap="round" />
                                </svg>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span id="noshow-rate" class="text-2xl font-bold text-gray-800">0%</span>
                                </div>
                            </div>
                            <p class="text-gray-600 font-semibold">No-Show Rate</p>
                            <p class="text-xs text-gray-500 mt-1">Missed appointments</p>
                        </div>
                        
                        <div class="text-center">
                            <div class="w-24 h-24 mx-auto mb-3 flex items-center justify-center">
                                <div class="text-center">
                                    <p id="avg-daily" class="text-4xl font-bold text-blue-600">0</p>
                                    <p class="text-xs text-gray-500">per day</p>
                                </div>
                            </div>
                            <p class="text-gray-600 font-semibold">Average Daily</p>
                            <p class="text-xs text-gray-500 mt-1">Appointments per day</p>
                        </div>
                    </div>
                </div>
                
                <!-- Growth Metrics -->
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold text-gray-800">New Patients</h4>
                            <i class="fas fa-user-plus text-2xl text-blue-500"></i>
                        </div>
                        <p id="sys-new-patients" class="text-4xl font-bold text-gray-800 mb-2">0</p>
                        <p class="text-sm text-gray-600">This month</p>
                        <div id="sys-patients-growth" class="mt-2 text-sm font-semibold"></div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold text-gray-800">Appointments</h4>
                            <i class="fas fa-calendar-alt text-2xl text-green-500"></i>
                        </div>
                        <p id="sys-month-appointments" class="text-4xl font-bold text-gray-800 mb-2">0</p>
                        <p class="text-sm text-gray-600">This month</p>
                        <div id="sys-appts-growth" class="mt-2 text-sm font-semibold"></div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold text-gray-800">System Growth</h4>
                            <i class="fas fa-chart-line text-2xl text-purple-500"></i>
                        </div>
                        <p id="sys-overall-growth" class="text-4xl font-bold text-gray-800 mb-2">0%</p>
                        <p class="text-sm text-gray-600">Month-over-month</p>
                        <div id="sys-growth-trend" class="mt-2 text-sm font-semibold"></div>
                    </div>
                </div>
                
                <!-- Top Performers -->
                <div class="grid md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-trophy text-yellow-500 mr-2"></i> Top Clinic
                        </h4>
                        <div id="sys-top-clinic" class="text-gray-600"></div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-star text-yellow-500 mr-2"></i> Top Doctor
                        </h4>
                        <div id="sys-top-doctor" class="text-gray-600"></div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h4 class="font-bold text-gray-800 mb-4 flex items-center">
                            <i class="fas fa-fire text-orange-500 mr-2"></i> Popular Service
                        </h4>
                        <div id="sys-top-service" class="text-gray-600"></div>
                    </div>
                </div>
                
                <!-- Appointment Status Distribution -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Appointment Status Distribution</h3>
                    <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
                        <div class="bg-blue-50 rounded-lg p-4 text-center">
                            <i class="fas fa-calendar-plus text-3xl text-blue-600 mb-2"></i>
                            <p id="sys-status-booked" class="text-3xl font-bold text-blue-700">0</p>
                            <p class="text-sm text-blue-600 font-semibold mt-1">Booked</p>
                            <p id="sys-status-booked-pct" class="text-xs text-blue-500"></p>
                        </div>
                        <div class="bg-purple-50 rounded-lg p-4 text-center">
                            <i class="fas fa-check-circle text-3xl text-purple-600 mb-2"></i>
                            <p id="sys-status-approve" class="text-3xl font-bold text-purple-700">0</p>
                            <p class="text-sm text-purple-600 font-semibold mt-1">Approved</p>
                            <p id="sys-status-approve-pct" class="text-xs text-purple-500"></p>
                        </div>
                        <div class="bg-green-50 rounded-lg p-4 text-center">
                            <i class="fas fa-calendar-check text-3xl text-green-600 mb-2"></i>
                            <p id="sys-status-appointment" class="text-3xl font-bold text-green-700">0</p>
                            <p class="text-sm text-green-600 font-semibold mt-1">Scheduled</p>
                            <p id="sys-status-appointment-pct" class="text-xs text-green-500"></p>
                        </div>
                        <div class="bg-gray-50 rounded-lg p-4 text-center">
                            <i class="fas fa-check-double text-3xl text-gray-600 mb-2"></i>
                            <p id="sys-status-completed" class="text-3xl font-bold text-gray-700">0</p>
                            <p class="text-sm text-gray-600 font-semibold mt-1">Completed</p>
                            <p id="sys-status-completed-pct" class="text-xs text-gray-500"></p>
                        </div>
                        <div class="bg-red-50 rounded-lg p-4 text-center">
                            <i class="fas fa-times-circle text-3xl text-red-600 mb-2"></i>
                            <p id="sys-status-cancelled" class="text-3xl font-bold text-red-700">0</p>
                            <p class="text-sm text-red-600 font-semibold mt-1">Cancelled</p>
                            <p id="sys-status-cancelled-pct" class="text-xs text-red-500"></p>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-4 text-center">
                            <i class="fas fa-user-slash text-3xl text-orange-600 mb-2"></i>
                            <p id="sys-status-missed" class="text-3xl font-bold text-orange-700">0</p>
                            <p class="text-sm text-orange-600 font-semibold mt-1">Missed</p>
                            <p id="sys-status-missed-pct" class="text-xs text-orange-500"></p>
                        </div>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50"></div>
    
    <!-- Modal Container -->
    <div id="modal-container"></div>
    
    <!-- Global Loading Spinner -->
    <div id="global-loading" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[100] flex items-center justify-center">
        <div class="bg-white rounded-xl p-8 shadow-2xl text-center">
            <div class="relative w-16 h-16 mx-auto mb-4">
                <div class="absolute inset-0 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin"></div>
            </div>
            <p id="loading-text" class="text-gray-700 font-semibold">Loading...</p>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCjJLE_Mgrv3HONhkkgApmUNVlGdnAIcvI",
            authDomain: "clinic-a17bc.firebaseapp.com",
            projectId: "clinic-a17bc",
            storageBucket: "clinic-a17bc.firebasestorage.app",
            messagingSenderId: "5214960983",
            appId: "1:5214960983:web:4da52f47c510a50b3cd212",
            measurementId: "G-7YM2Z0BY98"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // GHL API Configuration
        const GHL_API_KEY = 'pit-5b612d16-1609-43c6-a669-322e9197a9a9';
        const GHL_LOCATION_ID = 'xzA6eU8kOYmBuwFdr3CF';
        const GHL_API_BASE_URL = 'https://services.leadconnectorhq.com';
        
        // Global variables
        let currentUser = null;
        let allClinics = [];
        let allAppointments = [];
        let authInitialized = false;
        
        // Check authentication
        function checkAuth() {
            const userStr = localStorage.getItem('currentUser');
            if (!userStr) {
                window.location.href = 'superadmin-login.html';
                return false;
            }
            
            currentUser = JSON.parse(userStr);
            if (currentUser.role !== 'superadmin') {
                window.location.href = 'superadmin-login.html';
                return false;
            }
            
            document.getElementById('user-name').textContent = currentUser.name || 'Super Admin';
            return true;
        }
        
        // Logout
        async function logout() {
            try {
                await auth.signOut();
                localStorage.removeItem('currentUser');
                sessionStorage.clear();
                window.location.href = 'superadmin-login.html';
            } catch (error) {
                console.error('Logout error:', error);
                // Force logout even if Firebase signOut fails
                localStorage.removeItem('currentUser');
                sessionStorage.clear();
                window.location.href = 'superadmin-login.html';
            }
        }
        
        // Loading spinner functions
        function showLoading(text = 'Loading...') {
            document.getElementById('loading-text').textContent = text;
            document.getElementById('global-loading').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('global-loading').classList.add('hidden');
        }
        
        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-yellow-500';
            toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg mb-2`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        // Modern Confirm Modal (replaces browser confirm)
        function showConfirmModal(title, message, onConfirm, confirmText = 'Confirm', confirmColor = 'red') {
            const colors = {
                red: 'bg-red-600 hover:bg-red-700',
                green: 'bg-green-600 hover:bg-green-700',
                blue: 'bg-blue-600 hover:bg-blue-700',
                yellow: 'bg-yellow-600 hover:bg-yellow-700'
            };
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'confirm-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all">
                    <div class="bg-gradient-to-r from-gray-800 to-gray-900 px-6 py-4">
                        <h3 class="text-xl font-bold text-white flex items-center"><i class="fas fa-exclamation-triangle mr-2 text-yellow-400"></i>${title}</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-700 mb-6">${message}</p>
                        <div class="flex space-x-3">
                            <button id="confirm-modal-btn" onclick="confirmModalAction(true)" class="flex-1 ${colors[confirmColor]} text-white px-6 py-3 rounded-xl transition-all font-semibold shadow-lg">
                                <i class="fas fa-check mr-2"></i>${confirmText}
                            </button>
                            <button id="confirm-modal-cancel" onclick="confirmModalAction(false)" class="flex-1 bg-gray-200 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-300 transition-all font-semibold">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.confirmModalCallback = onConfirm;
        }
        
        async function confirmModalAction(confirmed) {
            if (confirmed && window.confirmModalCallback) {
                // Show loading on confirm button
                const btn = document.getElementById('confirm-modal-btn');
                const cancelBtn = document.getElementById('confirm-modal-cancel');
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';
                    btn.disabled = true;
                }
                if (cancelBtn) cancelBtn.disabled = true;
                
                try {
                    await window.confirmModalCallback();
                } finally {
                    const modal = document.getElementById('confirm-modal');
                    if (modal) modal.remove();
                    window.confirmModalCallback = null;
                }
            } else {
                const modal = document.getElementById('confirm-modal');
                if (modal) modal.remove();
                window.confirmModalCallback = null;
            }
        }
        
        // Modern Info Modal (replaces browser alert)
        function showInfoModal(title, message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'info-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden">
                    <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4">
                        <h3 class="text-xl font-bold text-white flex items-center"><i class="fas fa-info-circle mr-2"></i>${title}</h3>
                    </div>
                    <div class="p-6">
                        <p class="text-gray-700 mb-6">${message}</p>
                        <button onclick="closeInfoModal()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl transition-all font-semibold">
                            <i class="fas fa-check mr-2"></i>OK
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeInfoModal() {
            const modal = document.getElementById('info-modal');
            if (modal) modal.remove();
        }
        
        // Toggle sidebar
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }
        
        // Show section
        async function showSection(sectionName) {
            showLoading('Loading section...');
            
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            const section = document.getElementById(`section-${sectionName}`);
            if (section) section.classList.add('active');
            
            event.target.closest('.nav-btn').classList.add('active');
            
            try {
                switch(sectionName) {
                    case 'dashboard': await loadDashboard(); break;
                    case 'clinics': await loadClinics(); break;
                    case 'admins': await loadAdmins(); break;
                    case 'doctors': await loadDoctors(); break;
                    case 'staff': await loadStaff(); break;
                    case 'appointments': await loadAppointments(); break;
                    case 'patients': await loadPatients(); break;
                    case 'clinic-analytics': await loadClinicAnalytics(); break;
                    case 'patient-analytics': await loadPatientAnalytics(); break;
                    case 'analytics': await loadAnalytics(); break;
                }
            } finally {
                hideLoading();
            }
            
            if (window.innerWidth < 768) toggleSidebar();
        }
        
        // Close modal
        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }
        
        // ========== DASHBOARD FUNCTIONS ==========
        
        async function loadDashboard() {
            try {
                const clinicsSnap = await db.collection('clinics').where('active', '==', true).get();
                const doctorsSnap = await db.collection('users').where('role', '==', 'doctor').get();
                const staffSnap = await db.collection('users').where('role', '==', 'staff').get();
                const appointmentsSnap = await db.collection('appointments').get();
                
                document.getElementById('stat-clinics').textContent = clinicsSnap.size;
                document.getElementById('stat-doctors').textContent = doctorsSnap.size;
                document.getElementById('stat-staff').textContent = staffSnap.size;
                document.getElementById('stat-appointments').textContent = appointmentsSnap.size;
                
                const recentClinicsContainer = document.getElementById('recent-clinics');
                recentClinicsContainer.innerHTML = '';
                
                if (clinicsSnap.empty) {
                    recentClinicsContainer.innerHTML = '<p class="text-gray-500 text-sm">No clinics yet. Create your first clinic!</p>';
                } else {
                    // Count doctors for each clinic
                    const clinicDoctorCounts = {};
                    doctorsSnap.docs.forEach(doc => {
                        const doctor = doc.data();
                        const clinicId = doctor.clinicId;
                        if (clinicId) {
                            clinicDoctorCounts[clinicId] = (clinicDoctorCounts[clinicId] || 0) + 1;
                        }
                    });
                    
                    clinicsSnap.docs.slice(0, 5).forEach(doc => {
                        const clinic = { id: doc.id, ...doc.data() };
                        const doctorCount = clinicDoctorCounts[clinic.id] || 0;
                        recentClinicsContainer.innerHTML += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <i class="fas fa-hospital text-primary"></i>
                                    <div>
                                        <p class="font-semibold text-gray-800">${clinic.name}</p>
                                        <p class="text-xs text-gray-600">${clinic.city || clinic.address || 'N/A'}</p>
                                    </div>
                                </div>
                                <span class="text-xs text-gray-500">${doctorCount} doctors</span>
                            </div>
                        `;
                    });
                }
                
                const recentAppointmentsContainer = document.getElementById('recent-appointments');
                recentAppointmentsContainer.innerHTML = '';
                
                if (appointmentsSnap.empty) {
                    recentAppointmentsContainer.innerHTML = '<p class="text-gray-500 text-sm">No appointments yet</p>';
                } else {
                    const appointments = appointmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    appointments.sort((a, b) => {
                        const dateA = a.createdAt?.toDate() || new Date(0);
                        const dateB = b.createdAt?.toDate() || new Date(0);
                        return dateB - dateA;
                    });
                    
                    appointments.slice(0, 5).forEach(apt => {
                        const statusColors = {
                            'booked': 'bg-blue-100 text-blue-800',
                            'approve': 'bg-purple-100 text-purple-800',
                            'appointment': 'bg-green-100 text-green-800',
                            'missed': 'bg-orange-100 text-orange-800',
                            'cancelled': 'bg-red-100 text-red-800',
                            'completed': 'bg-gray-100 text-gray-800'
                        };
                        const statusColor = statusColors[apt.status] || 'bg-gray-100 text-gray-800';
                        
                        recentAppointmentsContainer.innerHTML += `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div>
                                    <p class="font-semibold text-gray-800">${apt.patientName || 'N/A'}</p>
                                    <p class="text-xs text-gray-600">${apt.date || 'N/A'} at ${apt.time || apt.startTime || 'N/A'}</p>
                                </div>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">${apt.status || 'N/A'}</span>
                            </div>
                        `;
                    });
                }
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showToast('Error loading dashboard', 'error');
            }
        }
        
        // ========== CLINICS MANAGEMENT ==========
        
        async function loadClinics() {
            try {
                const snapshot = await db.collection('clinics').orderBy('createdAt', 'desc').get();
                allClinics = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Load all admins to check connection status
                const adminsSnap = await db.collection('users').where('role', '==', 'admin').get();
                const adminsByClinic = {};
                adminsSnap.docs.forEach(doc => {
                    const admin = doc.data();
                    if (admin.clinicId) {
                        adminsByClinic[admin.clinicId] = admin;
                    }
                });
                
                // Load stats for each clinic
                const doctorsSnap = await db.collection('users').where('role', '==', 'doctor').get();
                const staffSnap = await db.collection('users').where('role', '==', 'staff').get();
                const appointmentsSnap = await db.collection('appointments').get();
                
                const statsByClinic = {};
                allClinics.forEach(c => {
                    statsByClinic[c.id] = {
                        // Count doctors: check both clinicId (single) and clinicIds (array)
                        doctors: doctorsSnap.docs.filter(d => {
                            const data = d.data();
                            if (data.clinicId === c.id) return true;
                            if (data.clinicIds && data.clinicIds.includes(c.id)) return true;
                            return false;
                        }).length,
                        staff: staffSnap.docs.filter(d => d.data().clinicId === c.id).length,
                        appointments: appointmentsSnap.docs.filter(d => d.data().clinicId === c.id).length
                    };
                });
                
                const container = document.getElementById('clinics-grid');
                container.innerHTML = '';
                
                if (allClinics.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500">No clinics yet. Create your first clinic!</p></div>';
                    return;
                }
                
                allClinics.forEach(clinic => {
                    const admin = adminsByClinic[clinic.id];
                    const stats = statsByClinic[clinic.id] || { doctors: 0, staff: 0, appointments: 0 };
                    const isConnected = !!admin;
                    const clinicIcon = clinic.branding?.icon || 'fa-hospital';
                    const clinicColor = clinic.branding?.primaryColor || '#0066cc';
                    const card = `
                        <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 rounded-lg flex items-center justify-center" style="background-color: ${clinicColor}">
                                        <i class="fas ${clinicIcon} text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800">${clinic.name}</h3>
                                        <p class="text-xs text-gray-500">${clinic.type || ''}</p>
                                        <p class="text-xs text-gray-600">${clinic.city || clinic.address || 'N/A'}</p>
                                    </div>
                                </div>
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${clinic.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                                    ${clinic.active ? 'Active' : 'Inactive'}
                                </span>
                            </div>
                            
                            <!-- Connection Status -->
                            <div class="mb-4 p-3 rounded-lg ${isConnected ? 'bg-green-50 border border-green-200' : 'bg-yellow-50 border border-yellow-200'}">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <i class="fas fa-${isConnected ? 'check-circle text-green-600' : 'exclamation-triangle text-yellow-600'} mr-2"></i>
                                        <span class="text-sm font-semibold ${isConnected ? 'text-green-800' : 'text-yellow-800'}">
                                            ${isConnected ? 'CONNECTED' : 'NOT CONNECTED'}
                                        </span>
                                    </div>
                                    ${!isConnected ? `<button onclick="createAdminForClinic('${clinic.id}')" class="text-xs bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700"><i class="fas fa-plus mr-1"></i>Create Admin</button>` : ''}
                                </div>
                                ${isConnected ? `<p class="text-xs text-green-700 mt-1">Admin: ${admin.email}</p>` : '<p class="text-xs text-yellow-700 mt-1">No admin assigned yet</p>'}
                            </div>
                            
                            <!-- Clinic Website Link -->
                            ${clinic.website ? `
                            <a href="${clinic.website}" target="_blank" class="block mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg hover:bg-blue-100 transition">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center text-blue-700">
                                        <i class="fas fa-external-link-alt mr-2"></i>
                                        <span class="font-semibold text-sm">Open Clinic Website</span>
                                    </div>
                                    <i class="fas fa-arrow-right text-blue-500"></i>
                                </div>
                            </a>
                            ` : `
                            <div class="mb-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                <div class="flex items-center text-gray-500">
                                    <i class="fas fa-link mr-2"></i>
                                    <span class="text-sm">No website link set</span>
                                </div>
                            </div>
                            `}
                            
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-map-marker-alt w-5"></i>
                                    <span>${clinic.address || 'N/A'}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-phone w-5"></i>
                                    <span>${clinic.phone || 'N/A'}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-envelope w-5"></i>
                                    <span>${clinic.email || 'N/A'}</span>
                                </div>
                            </div>
                            
                            <!-- Stats -->
                            <div class="grid grid-cols-3 gap-2 mb-4 p-3 bg-gray-50 rounded-lg">
                                <div class="text-center">
                                    <div class="text-lg font-bold text-gray-800">${stats.doctors}</div>
                                    <div class="text-xs text-gray-600">Doctors</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-gray-800">${stats.staff}</div>
                                    <div class="text-xs text-gray-600">Staff</div>
                                </div>
                                <div class="text-center">
                                    <div class="text-lg font-bold text-gray-800">${stats.appointments}</div>
                                    <div class="text-xs text-gray-600">Appointments</div>
                                </div>
                            </div>
                            
                            <div class="flex items-center justify-between pt-4 border-t">
                                <button onclick="viewClinicDetails('${clinic.id}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                    <i class="fas fa-eye mr-1"></i>View Details
                                </button>
                                <div class="space-x-2">
                                    <button onclick="editClinic('${clinic.id}')" class="text-blue-600 hover:text-blue-800">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="deleteClinic('${clinic.id}')" class="text-red-600 hover:text-red-800">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                });
                
                updateClinicFilters();
                
            } catch (error) {
                console.error('Error loading clinics:', error);
                showToast('Error loading clinics', 'error');
            }
        }
        
        // Sync clinics from registry - adds new clinics AND updates existing ones
        async function syncClinicsFromRegistry() {
            // Show sync modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'sync-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6">
                    <div class="text-center mb-6">
                        <i class="fas fa-sync fa-spin text-5xl text-green-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800">Syncing Clinics</h3>
                        <p class="text-gray-600">Checking registry for new and updated clinics...</p>
                    </div>
                    <div id="sync-status" class="space-y-2">
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-spinner fa-spin mr-2"></i>
                            <span>Loading registry...</span>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const statusDiv = document.getElementById('sync-status');
            
            try {
                // Load manifest from registry
                statusDiv.innerHTML = '<div class="flex items-center text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i><span>Loading manifest...</span></div>';
                
                const manifestResponse = await fetch('../clinics-registry/manifest.json');
                if (!manifestResponse.ok) throw new Error('Could not load manifest.json');
                const manifest = await manifestResponse.json();
                
                statusDiv.innerHTML += `<div class="flex items-center text-green-600"><i class="fas fa-check mr-2"></i><span>Found ${manifest.clinics.length} clinics in registry</span></div>`;
                
                // Load each clinic JSON
                const registryClinics = [];
                for (const file of manifest.clinics) {
                    const response = await fetch(`../clinics-registry/${file}`);
                    if (response.ok) {
                        const clinic = await response.json();
                        registryClinics.push(clinic);
                    }
                }
                
                // Process each clinic
                let addedCount = 0;
                let updatedCount = 0;
                let skippedCount = 0;
                const results = [];
                
                for (const regClinic of registryClinics) {
                    statusDiv.innerHTML = `<div class="flex items-center text-gray-600"><i class="fas fa-spinner fa-spin mr-2"></i><span>Processing ${regClinic.name}...</span></div>`;
                    
                    // Check if clinic exists in Firestore
                    const existingDoc = await db.collection('clinics').doc(regClinic.id).get();
                    
                    if (existingDoc.exists) {
                        // Clinic exists - check for updates
                        const existing = existingDoc.data();
                        const updates = {};
                        let hasChanges = false;
                        
                        // Compare fields and collect updates
                        if (regClinic.name && regClinic.name !== existing.name) {
                            updates.name = regClinic.name;
                            hasChanges = true;
                        }
                        if (regClinic.type && regClinic.type !== existing.type) {
                            updates.type = regClinic.type;
                            hasChanges = true;
                        }
                        if (regClinic.address && regClinic.address !== existing.address) {
                            updates.address = regClinic.address;
                            hasChanges = true;
                        }
                        if (regClinic.city && regClinic.city !== existing.city) {
                            updates.city = regClinic.city;
                            hasChanges = true;
                        }
                        if (regClinic.phone && regClinic.phone !== existing.phone) {
                            updates.phone = regClinic.phone;
                            hasChanges = true;
                        }
                        if (regClinic.email && regClinic.email !== existing.email) {
                            updates.email = regClinic.email;
                            hasChanges = true;
                        }
                        if (regClinic.website && regClinic.website !== existing.website) {
                            updates.website = regClinic.website;
                            hasChanges = true;
                        }
                        if (regClinic.branding) {
                            const existingBranding = existing.branding || {};
                            if (regClinic.branding.primaryColor !== existingBranding.primaryColor ||
                                regClinic.branding.secondaryColor !== existingBranding.secondaryColor ||
                                regClinic.branding.icon !== existingBranding.icon) {
                                updates.branding = regClinic.branding;
                                hasChanges = true;
                            }
                        }
                        
                        if (hasChanges) {
                            updates.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                            await db.collection('clinics').doc(regClinic.id).update(updates);
                            results.push({ type: 'updated', clinic: regClinic.name, changes: Object.keys(updates).filter(k => k !== 'updatedAt') });
                            updatedCount++;
                        } else {
                            results.push({ type: 'skipped', clinic: regClinic.name, message: 'No changes' });
                            skippedCount++;
                        }
                    } else {
                        // New clinic - add it
                        await db.collection('clinics').doc(regClinic.id).set({
                            name: regClinic.name,
                            type: regClinic.type || '',
                            slug: regClinic.slug || '',
                            address: regClinic.address || '',
                            city: regClinic.city || '',
                            phone: regClinic.phone || '',
                            email: regClinic.email || '',
                            website: regClinic.website || '',
                            branding: regClinic.branding || {},
                            active: true,
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        results.push({ type: 'added', clinic: regClinic.name });
                        addedCount++;
                    }
                }
                
                // Show results
                const modalContent = document.querySelector('#sync-modal > div');
                modalContent.innerHTML = `
                    <div class="text-center mb-6">
                        <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800">Sync Complete!</h3>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-green-600">${addedCount}</div>
                            <div class="text-sm text-green-700">Added</div>
                        </div>
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-blue-600">${updatedCount}</div>
                            <div class="text-sm text-blue-700">Updated</div>
                        </div>
                        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 text-center">
                            <div class="text-2xl font-bold text-gray-600">${skippedCount}</div>
                            <div class="text-sm text-gray-700">No Changes</div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 rounded-lg p-4 max-h-48 overflow-y-auto mb-6">
                        <p class="font-semibold text-gray-800 mb-2">Details:</p>
                        <div class="space-y-1 text-sm">
                            ${results.map(r => `
                                <div class="flex items-center">
                                    <i class="fas fa-${r.type === 'added' ? 'plus-circle text-green-500' : r.type === 'updated' ? 'edit text-blue-500' : 'minus-circle text-gray-400'} mr-2"></i>
                                    <span class="font-medium">${r.clinic}</span>
                                    <span class="text-gray-500 ml-2">
                                        ${r.type === 'added' ? '- New clinic added' : r.type === 'updated' ? `- Updated: ${r.changes.join(', ')}` : '- No changes'}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <button onclick="document.getElementById('sync-modal').remove(); loadClinics();" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                        <i class="fas fa-check mr-2"></i>Done
                    </button>
                `;
                
            } catch (error) {
                console.error('Error syncing clinics:', error);
                const modalContent = document.querySelector('#sync-modal > div');
                modalContent.innerHTML = `
                    <div class="text-center mb-6">
                        <i class="fas fa-exclamation-triangle text-5xl text-red-500 mb-4"></i>
                        <h3 class="text-2xl font-bold text-gray-800">Sync Failed</h3>
                        <p class="text-red-600">${error.message}</p>
                    </div>
                    <button onclick="document.getElementById('sync-modal').remove();" class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-gray-700 transition">
                        <i class="fas fa-times mr-2"></i>Close
                    </button>
                `;
            }
        }
        
        function showAddClinicModal() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 max-h-screen overflow-y-auto">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Add New Clinic</h3>
                    <form id="clinic-form" class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Clinic Name *</label>
                            <input type="text" id="clinic-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Address *</label>
                            <input type="text" id="clinic-address" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">City *</label>
                            <input type="text" id="clinic-city" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Phone *</label>
                            <input type="tel" id="clinic-phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">Email *</label>
                            <input type="email" id="clinic-email" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="flex space-x-2">
                            <button type="submit" class="flex-1 bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save
                            </button>
                            <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
            
            document.getElementById('clinic-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                try {
                    const clinicData = {
                        name: document.getElementById('clinic-name').value,
                        address: document.getElementById('clinic-address').value,
                        city: document.getElementById('clinic-city').value,
                        phone: document.getElementById('clinic-phone').value,
                        email: document.getElementById('clinic-email').value.toLowerCase(),
                        adminId: null,
                        doctors: [],
                        staff: [],
                        active: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('clinics').add(clinicData);
                    showToast('Clinic added successfully', 'success');
                    closeModal();
                    loadClinics();
                    loadDashboard();
                } catch (error) {
                    console.error('Error adding clinic:', error);
                    showToast('Error adding clinic', 'error');
                }
            });
        }
        
        async function editClinic(clinicId) {
            try {
                const doc = await db.collection('clinics').doc(clinicId).get();
                const clinic = { id: doc.id, ...doc.data() };
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 max-h-screen overflow-y-auto">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Edit Clinic</h3>
                        <form id="edit-clinic-form" class="space-y-4">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Clinic Name *</label>
                                <input type="text" id="edit-clinic-name" value="${clinic.name}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Address *</label>
                                <input type="text" id="edit-clinic-address" value="${clinic.address || ''}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">City *</label>
                                <input type="text" id="edit-clinic-city" value="${clinic.city || ''}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Phone *</label>
                                <input type="tel" id="edit-clinic-phone" value="${clinic.phone || ''}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Email *</label>
                                <input type="email" id="edit-clinic-email" value="${clinic.email || ''}" required class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">Website URL</label>
                                <input type="url" id="edit-clinic-website" value="${clinic.website || ''}" placeholder="https://clinic-website.vercel.app" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <p class="text-xs text-gray-500 mt-1">Enter the full URL including https://</p>
                            </div>
                            <div>
                                <label class="flex items-center space-x-2">
                                    <input type="checkbox" id="edit-clinic-active" ${clinic.active ? 'checked' : ''} class="w-4 h-4">
                                    <span class="text-gray-700 font-semibold">Active</span>
                                </label>
                            </div>
                            <div class="flex space-x-2">
                                <button type="submit" class="flex-1 bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                                    Update
                                </button>
                                <button type="button" onclick="closeModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
                
                document.getElementById('edit-clinic-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    try {
                        await db.collection('clinics').doc(clinicId).update({
                            name: document.getElementById('edit-clinic-name').value,
                            address: document.getElementById('edit-clinic-address').value,
                            city: document.getElementById('edit-clinic-city').value,
                            phone: document.getElementById('edit-clinic-phone').value,
                            email: document.getElementById('edit-clinic-email').value.toLowerCase(),
                            website: document.getElementById('edit-clinic-website').value.trim(),
                            active: document.getElementById('edit-clinic-active').checked,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        showToast('Clinic updated successfully', 'success');
                        closeModal();
                        loadClinics();
                        loadDashboard();
                    } catch (error) {
                        console.error('Error updating clinic:', error);
                        showToast('Error updating clinic', 'error');
                    }
                });
            } catch (error) {
                console.error('Error loading clinic:', error);
                showToast('Error loading clinic', 'error');
            }
        }
        
        function deleteClinic(clinicId) {
            showConfirmModal('Deactivate Clinic', 'Are you sure you want to deactivate this clinic?', async () => {
                try {
                    await db.collection('clinics').doc(clinicId).update({
                        active: false,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    showToast('Clinic deactivated successfully', 'success');
                    loadClinics();
                    loadDashboard();
                } catch (error) {
                    console.error('Error deactivating clinic:', error);
                    showToast('Error deactivating clinic', 'error');
                }
            }, 'Deactivate', 'red');
        }
        
        function createAdminForClinic(clinicId) {
            // Pre-select the clinic in the admin creation modal
            showAddAdminModal();
            setTimeout(() => {
                const clinicSelect = document.getElementById('admin-clinic');
                if (clinicSelect) {
                    clinicSelect.value = clinicId;
                }
            }, 100);
        }
        
        function viewClinicDetails(clinicId) {
            const clinic = allClinics.find(c => c.id === clinicId);
            if (!clinic) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full p-6 max-h-screen overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-hospital text-primary mr-2"></i>${clinic.name}
                        </h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-gray-800 mb-2">Contact Information</h4>
                            <div class="space-y-2 text-sm">
                                <p><i class="fas fa-map-marker-alt w-5 text-gray-600"></i> ${clinic.address || 'N/A'}</p>
                                <p><i class="fas fa-phone w-5 text-gray-600"></i> ${clinic.phone || 'N/A'}</p>
                                <p><i class="fas fa-envelope w-5 text-gray-600"></i> ${clinic.email || 'N/A'}</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-gray-800 mb-2">Clinic Details</h4>
                            <div class="space-y-2 text-sm">
                                <p><strong>Clinic ID:</strong> ${clinic.id}</p>
                                <p><strong>Slug:</strong> ${clinic.slug || 'N/A'}</p>
                                <p><strong>Status:</strong> <span class="px-2 py-1 rounded-full text-xs ${clinic.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${clinic.active ? 'Active' : 'Inactive'}</span></p>
                                <p><strong>Created:</strong> ${clinic.createdAt ? new Date(clinic.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                            </div>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('modal-container').appendChild(modal);
        }
        
        // ========== PATIENT DATABASE ==========
        
        let allPatients = [];
        let currentPatient = null;
        
        async function loadPatients() {
            try {
                // PATIENT-FIRST APPROACH: Start from patients collection
                const patientsSnap = await db.collection('patients').get();
                const appointmentsSnap = await db.collection('appointments').get();
                const clinicsSnap = await db.collection('clinics').get();
                
                // Build clinics lookup
                const clinics = {};
                clinicsSnap.docs.forEach(doc => {
                    clinics[doc.id] = doc.data().name;
                });
                
                // Build appointments lookup by patientId and email
                const appointmentsByPatientId = {};
                const appointmentsByEmail = {};
                appointmentsSnap.docs.forEach(doc => {
                    const apt = { id: doc.id, ...doc.data() };
                    // Group by patientId (new appointments)
                    if (apt.patientId) {
                        if (!appointmentsByPatientId[apt.patientId]) appointmentsByPatientId[apt.patientId] = [];
                        appointmentsByPatientId[apt.patientId].push(apt);
                    }
                    // Also group by email (for legacy appointments without patientId)
                    if (apt.patientEmail) {
                        if (!appointmentsByEmail[apt.patientEmail]) appointmentsByEmail[apt.patientEmail] = [];
                        appointmentsByEmail[apt.patientEmail].push(apt);
                    }
                });
                
                // Build patients array from patients collection
                allPatients = patientsSnap.docs.map(doc => {
                    const data = doc.data();
                    const firestoreId = doc.id;
                    
                    // Get visits from appointments (by patientId or email)
                    const visits = [
                        ...(appointmentsByPatientId[firestoreId] || []),
                        ...(appointmentsByEmail[data.email] || [])
                    ];
                    // Remove duplicates (same appointment might be in both)
                    const uniqueVisits = visits.filter((v, i, arr) => arr.findIndex(x => x.id === v.id) === i);
                    
                    // Get clinics visited
                    const clinicsVisited = [...new Set(uniqueVisits.map(v => v.clinicId).filter(Boolean))];
                    
                    // Calculate metrics
                    const sortedVisits = uniqueVisits.sort((a, b) => new Date(b.date) - new Date(a.date));
                    const lastVisit = sortedVisits[0];
                    const daysSinceLastVisit = lastVisit ? Math.floor((new Date() - new Date(lastVisit.date)) / (1000 * 60 * 60 * 24)) : 999;
                    
                    let status = 'Active';
                    if (daysSinceLastVisit > 180) status = 'Inactive';
                    else if (uniqueVisits.length === 1) status = 'New';
                    else if (uniqueVisits.length === 0) status = 'No Visits';
                    
                    return {
                        id: firestoreId,
                        firestoreId: firestoreId,
                        name: data.name,
                        email: data.email,
                        phone: data.phone,
                        visits: uniqueVisits,
                        clinicsVisited: clinicsVisited,
                        totalVisits: uniqueVisits.length,
                        lastVisit: lastVisit ? lastVisit.date : 'Never',
                        status: status,
                        daysSinceLastVisit: daysSinceLastVisit,
                        // Load saved data
                        medicalHistory: data.medicalHistory || {},
                        bloodProfile: data.bloodProfile || {},
                        dentalChart: data.dentalChart || {},
                        treatmentPlans: data.treatmentPlans || [],
                        files: data.files || {}
                    };
                });
                
                displayPatients(allPatients);
                
                // Populate clinic filter
                const clinicFilter = document.getElementById('patient-filter-clinic');
                clinicFilter.innerHTML = '<option value="">All Clinics</option>';
                Object.entries(clinics).forEach(([id, name]) => {
                    clinicFilter.innerHTML += `<option value="${id}">${name}</option>`;
                });
                
            } catch (error) {
                console.error('Error loading patients:', error);
                showToast('Error loading patients', 'error');
            }
        }
        
        function displayPatients(patients) {
            const tbody = document.getElementById('patients-table-body');
            tbody.innerHTML = '';
            
            if (patients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">No patients found</td></tr>';
                return;
            }
            
            patients.forEach(patient => {
                const statusColors = {
                    'Active': 'bg-green-100 text-green-800',
                    'Inactive': 'bg-red-100 text-red-800',
                    'New': 'bg-blue-100 text-blue-800'
                };
                
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 text-sm text-gray-600">${patient.id}</td>
                        <td class="px-6 py-4 font-semibold text-gray-800">${patient.name || 'N/A'}</td>
                        <td class="px-6 py-4 text-sm">
                            <div class="text-gray-600">${patient.phone || 'N/A'}</div>
                            <div class="text-xs text-gray-500">${patient.email || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">${patient.clinicsVisited.length} clinic(s)</td>
                        <td class="px-6 py-4 font-semibold text-gray-800">${patient.totalVisits}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${patient.lastVisit}</td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[patient.status]}">${patient.status}</span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick='viewPatientProfile(${JSON.stringify(patient).replace(/'/g, "&#39;")})' class="text-purple-600 hover:text-purple-800 font-semibold text-sm">
                                <i class="fas fa-eye mr-1"></i> View
                            </button>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        function searchPatients() {
            const query = document.getElementById('patient-search').value.toLowerCase();
            const filtered = allPatients.filter(p => 
                (p.name && p.name.toLowerCase().includes(query)) ||
                (p.email && p.email.toLowerCase().includes(query)) ||
                (p.phone && p.phone.includes(query))
            );
            displayPatients(filtered);
        }
        
        function filterPatients() {
            const clinicFilter = document.getElementById('patient-filter-clinic').value;
            const statusFilter = document.getElementById('patient-filter-status').value;
            
            let filtered = allPatients;
            
            if (clinicFilter) {
                filtered = filtered.filter(p => p.clinicsVisited.includes(clinicFilter));
            }
            
            if (statusFilter) {
                filtered = filtered.filter(p => p.status.toLowerCase() === statusFilter);
            }
            
            displayPatients(filtered);
        }
        
        function clearPatientFilters() {
            document.getElementById('patient-search').value = '';
            document.getElementById('patient-filter-clinic').value = '';
            document.getElementById('patient-filter-status').value = '';
            displayPatients(allPatients);
        }
        
        function viewPatientProfile(patient) {
            currentPatient = patient;
            document.getElementById('patient-list-view').classList.add('hidden');
            document.getElementById('patient-profile-view').classList.remove('hidden');
            
            // Set patient header
            document.getElementById('profile-patient-name').textContent = patient.name || 'Unknown Patient';
            document.getElementById('profile-patient-id').textContent = `Patient ID: ${patient.id}`;
            
            const statusColors = {
                'Active': 'bg-green-500',
                'Inactive': 'bg-red-500',
                'New': 'bg-blue-500'
            };
            document.getElementById('profile-patient-status').innerHTML = `
                <span class="px-4 py-2 rounded-full text-sm font-semibold ${statusColors[patient.status]} text-white">
                    ${patient.status}
                </span>
            `;
            
            // Show overview tab by default
            showPatientTab('overview');
        }
        
        function closePatientProfile() {
            document.getElementById('patient-list-view').classList.remove('hidden');
            document.getElementById('patient-profile-view').classList.add('hidden');
            currentPatient = null;
        }
        
        async function showPatientTab(tabName) {
            // Update tab buttons - highlight the active tab
            document.querySelectorAll('.patient-tab-btn').forEach(btn => {
                btn.classList.remove('border-purple-600', 'text-purple-600');
                btn.classList.add('border-transparent', 'text-gray-500');
                // Find the button that matches the tabName and highlight it
                if (btn.getAttribute('onclick')?.includes(`'${tabName}'`)) {
                    btn.classList.remove('border-transparent', 'text-gray-500');
                    btn.classList.add('border-purple-600', 'text-purple-600');
                }
            });
            
            const content = document.getElementById('patient-tab-content');
            
            if (tabName === 'overview') {
                content.innerHTML = `
                    <div class="grid md:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Contact Information</h3>
                            <div class="space-y-3">
                                <div><span class="text-gray-600">Email:</span> <span class="font-semibold">${currentPatient.email || 'N/A'}</span></div>
                                <div><span class="text-gray-600">Phone:</span> <span class="font-semibold">${currentPatient.phone || 'N/A'}</span></div>
                                <div><span class="text-gray-600">Patient ID:</span> <span class="font-semibold">${currentPatient.id}</span></div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Visit Summary</h3>
                            <div class="space-y-3">
                                <div><span class="text-gray-600">Total Visits:</span> <span class="font-semibold">${currentPatient.totalVisits}</span></div>
                                <div><span class="text-gray-600">Last Visit:</span> <span class="font-semibold">${currentPatient.lastVisit}</span></div>
                                <div><span class="text-gray-600">Clinics Visited:</span> <span class="font-semibold">${currentPatient.clinicsVisited.length}</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Visits</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Doctor</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Service</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${currentPatient.visits.slice(0, 5).map(visit => `
                                        <tr>
                                            <td class="px-4 py-3 text-sm">${visit.date}</td>
                                            <td class="px-4 py-3 text-sm">${visit.doctorName || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm">${visit.service || visit.patientService || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-full text-xs bg-gray-100">${visit.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (tabName === 'visits') {
                content.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-bold text-gray-800 mb-4">Complete Visit History</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Doctor</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Service</th>
                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${currentPatient.visits.map(visit => `
                                        <tr>
                                            <td class="px-4 py-3 text-sm">${visit.date}</td>
                                            <td class="px-4 py-3 text-sm">${visit.startTime || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm">${visit.doctorName || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm">${visit.service || visit.patientService || 'N/A'}</td>
                                            <td class="px-4 py-3 text-sm"><span class="px-2 py-1 rounded-full text-xs bg-gray-100">${visit.status}</span></td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            } else if (tabName === 'medical') {
                // Medical History Tab - Load saved data
                const allergies = currentPatient.medicalHistory?.allergies || [];
                const medications = currentPatient.medicalHistory?.medications || [];
                const conditions = currentPatient.medicalHistory?.conditions || [];
                const dentalConcerns = currentPatient.medicalHistory?.dentalConcerns || [];
                const bloodType = currentPatient.medicalHistory?.bloodType || '';
                const bloodPressure = currentPatient.medicalHistory?.bloodPressure || '';
                const emergencyContact = currentPatient.medicalHistory?.emergencyContact || '';
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <!-- Missing Information Alert -->
                        ${allergies.length === 0 && medications.length === 0 ? `
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3 mt-1"></i>
                                <div class="flex-1">
                                    <h4 class="font-bold text-yellow-800 mb-2"> Incomplete Medical Profile</h4>
                                    <p class="text-sm text-yellow-700 mb-3">Critical information is missing. Send a form to the patient to complete their medical history.</p>
                                    <button onclick="sendMedicalForm('${currentPatient.phone || currentPatient.email}')" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition text-sm font-semibold">
                                        <i class="fas fa-paper-plane mr-2"></i>Send Medical History Form
                                    </button>
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        
                        <!-- Allergies Section -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-red-600 flex items-center">
                                    <i class="fas fa-allergies mr-2"></i> ALLERGIES (${allergies.length})
                                </h3>
                                <button onclick="addAllergy()" class="text-red-600 hover:text-red-700 text-sm font-semibold">
                                    <i class="fas fa-plus mr-1"></i>Add
                                </button>
                            </div>
                            <div id="allergies-list" class="space-y-2">
                                ${allergies.length > 0 ? allergies.map(a => `
                                    <div class="flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-3">
                                        <span class="text-sm text-red-800 font-semibold"> ${a}</span>
                                        <button onclick="removeAllergy('${a}')" class="text-red-600 hover:text-red-800"><i class="fas fa-times"></i></button>
                                    </div>
                                `).join('') : `
                                    <div class="bg-red-50 border border-red-200 rounded-lg p-3 text-sm text-red-800">
                                        <i class="fas fa-info-circle mr-2"></i>No allergies recorded.
                                    </div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Current Medications -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-pills mr-2 text-blue-600"></i> Current Medications (${medications.length})
                                </h3>
                                <button onclick="addMedication()" class="text-blue-600 hover:text-blue-700 text-sm font-semibold">
                                    <i class="fas fa-plus mr-1"></i>Add
                                </button>
                            </div>
                            <div id="medications-list" class="space-y-2">
                                ${medications.length > 0 ? medications.map(m => `
                                    <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3">
                                        <span class="text-sm text-blue-800"> ${m}</span>
                                        <button onclick="removeMedication('${m}')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-times"></i></button>
                                    </div>
                                `).join('') : `
                                    <div class="text-sm text-gray-500 italic">No medications recorded</div>
                                `}
                            </div>
                        </div>
                        
                        <!-- Medical Conditions -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-hospital mr-2 text-green-600"></i> Medical Conditions
                                </h3>
                            </div>
                            <div id="medical-conditions-list" class="grid md:grid-cols-2 gap-3">
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Diabetes" class="form-checkbox text-purple-600" ${conditions.includes('Diabetes') ? 'checked' : ''}>
                                    <span class="text-sm">Diabetes</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="High Blood Pressure" class="form-checkbox text-purple-600" ${conditions.includes('High Blood Pressure') ? 'checked' : ''}>
                                    <span class="text-sm">High Blood Pressure</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Heart Disease" class="form-checkbox text-purple-600" ${conditions.includes('Heart Disease') ? 'checked' : ''}>
                                    <span class="text-sm">Heart Disease</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Asthma" class="form-checkbox text-purple-600" ${conditions.includes('Asthma') ? 'checked' : ''}>
                                    <span class="text-sm">Asthma</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Pregnancy" class="form-checkbox text-purple-600" ${conditions.includes('Pregnancy') ? 'checked' : ''}>
                                    <span class="text-sm">Pregnancy</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Bleeding Disorder" class="form-checkbox text-purple-600" ${conditions.includes('Bleeding Disorder') ? 'checked' : ''}>
                                    <span class="text-sm">Bleeding Disorder</span>
                                </label>
                            </div>
                            <button onclick="addCustomCondition()" class="mt-3 text-purple-600 hover:text-purple-700 text-sm font-semibold">
                                <i class="fas fa-plus mr-1"></i>Add Custom Condition
                            </button>
                        </div>
                        
                        <!-- Vital Information -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-heartbeat mr-2 text-red-600"></i> Vital Information
                            </h3>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Blood Pressure</label>
                                    <input type="text" id="vital-blood-pressure" value="${bloodPressure}" placeholder="120/80" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Emergency Contact</label>
                                    <input type="text" id="vital-emergency-contact" value="${emergencyContact}" placeholder="09123456789" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Dental Concerns -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-tooth mr-2 text-blue-600"></i> Dental Concerns
                            </h3>
                            <div id="dental-concerns-list" class="grid md:grid-cols-2 gap-3">
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Bleeding gums" class="form-checkbox text-purple-600" ${dentalConcerns.includes('Bleeding gums') ? 'checked' : ''}>
                                    <span class="text-sm">Bleeding gums</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Sensitive teeth" class="form-checkbox text-purple-600" ${dentalConcerns.includes('Sensitive teeth') ? 'checked' : ''}>
                                    <span class="text-sm">Sensitive teeth</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Jaw pain (TMJ)" class="form-checkbox text-purple-600" ${dentalConcerns.includes('Jaw pain (TMJ)') ? 'checked' : ''}>
                                    <span class="text-sm">Jaw pain (TMJ)</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Teeth grinding (Bruxism)" class="form-checkbox text-purple-600" ${dentalConcerns.includes('Teeth grinding (Bruxism)') ? 'checked' : ''}>
                                    <span class="text-sm">Teeth grinding (Bruxism)</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Bad breath" class="form-checkbox text-purple-600" ${dentalConcerns.includes('Bad breath') ? 'checked' : ''}>
                                    <span class="text-sm">Bad breath</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" value="Loose teeth" class="form-checkbox text-purple-600" ${dentalConcerns.includes('Loose teeth') ? 'checked' : ''}>
                                    <span class="text-sm">Loose teeth</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button id="btn-save-medical" onclick="saveMedicalHistory()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Medical History
                            </button>
                        </div>
                    </div>
                `;
            } else if (tabName === 'blood') {
                // Blood Profile Tab - Load saved data
                const bp = currentPatient.bloodProfile || {};
                const donations = bp.donations || [];
                const bpReadings = bp.bpReadings || [];
                const sugarReadings = bp.sugarReadings || [];
                const totalVolume = donations.reduce((sum, d) => sum + (d.volume || 0), 0);
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <!-- Blood Type & RH Factor -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-tint mr-2 text-red-600"></i> Blood Type & RH Factor
                            </h3>
                            <div class="grid md:grid-cols-4 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Blood Type</label>
                                    <select id="blood-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Not specified</option>
                                        <option value="A" ${bp.bloodType === 'A' ? 'selected' : ''}>A</option>
                                        <option value="B" ${bp.bloodType === 'B' ? 'selected' : ''}>B</option>
                                        <option value="AB" ${bp.bloodType === 'AB' ? 'selected' : ''}>AB</option>
                                        <option value="O" ${bp.bloodType === 'O' ? 'selected' : ''}>O</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">RH Factor</label>
                                    <select id="rh-factor" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Not specified</option>
                                        <option value="positive" ${bp.rhFactor === 'positive' ? 'selected' : ''}>Positive (+)</option>
                                        <option value="negative" ${bp.rhFactor === 'negative' ? 'selected' : ''}>Negative (-)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Verified</label>
                                    <label class="flex items-center space-x-2 mt-2">
                                        <input type="checkbox" id="blood-verified" class="form-checkbox text-purple-600" ${bp.verified ? 'checked' : ''}>
                                        <span class="text-sm">Lab confirmed</span>
                                    </label>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Last Updated</label>
                                    <input type="date" id="blood-last-updated" class="w-full px-3 py-2 border border-gray-300 rounded-lg" value="${bp.lastDonation || ''}">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Blood Donation History -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-hand-holding-heart mr-2 text-red-600"></i> Blood Donation History (${donations.length})
                                </h3>
                                <button onclick="addDonationRecord()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Add Donation
                                </button>
                            </div>
                            
                            <div id="donation-history" class="space-y-2 mb-4">
                                ${donations.length > 0 ? donations.map(d => `
                                    <div class="flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-3">
                                        <div>
                                            <span class="font-semibold text-red-800"> ${d.date}</span>
                                            <span class="text-sm text-gray-600 ml-2">${d.location || 'Unknown location'}</span>
                                        </div>
                                        <span class="text-sm font-semibold text-red-600">${d.volume || 450}ml - ${d.type || 'Whole Blood'}</span>
                                    </div>
                                `).join('') : `
                                    <p class="text-sm text-gray-500 italic">No donation records yet</p>
                                `}
                            </div>
                            
                            <div class="mt-4 grid md:grid-cols-2 gap-4">
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                    <p class="text-sm text-gray-600">Total Donations</p>
                                    <p class="text-2xl font-bold text-blue-600">${donations.length}</p>
                                </div>
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-3">
                                    <p class="text-sm text-gray-600">Total Volume</p>
                                    <p class="text-2xl font-bold text-purple-600">${totalVolume} ml</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Blood Pressure History -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-heartbeat mr-2 text-red-600"></i> Blood Pressure (${bpReadings.length})
                                </h3>
                                <button onclick="addBPReading()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Add Reading
                                </button>
                            </div>
                            ${bp.latestBP ? `<p class="text-lg mb-3">Latest: <span class="font-bold text-green-600">${bp.latestBP}</span></p>` : ''}
                            <div id="bp-history" class="space-y-2">
                                ${bpReadings.length > 0 ? bpReadings.slice(-5).reverse().map(r => `
                                    <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
                                        <span class="text-sm text-gray-600">${new Date(r.datetime || r.createdAt).toLocaleString()}</span>
                                        <span class="font-bold text-green-600">${r.systolic}/${r.diastolic}</span>
                                    </div>
                                `).join('') : `
                                    <p class="text-sm text-gray-500 italic">No blood pressure readings yet</p>
                                `}
                            </div>
                        </div>
                        
                        <!-- Blood Sugar History -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-candy-cane mr-2 text-pink-600"></i> Blood Sugar (${sugarReadings.length})
                                </h3>
                                <button onclick="addBloodSugar()" class="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition text-sm font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Add Reading
                                </button>
                            </div>
                            ${bp.latestSugar ? `<p class="text-lg mb-3">Latest: <span class="font-bold text-pink-600">${bp.latestSugar} mg/dL</span></p>` : ''}
                            <div id="sugar-history" class="space-y-2">
                                ${sugarReadings.length > 0 ? sugarReadings.slice(-5).reverse().map(r => `
                                    <div class="flex items-center justify-between bg-pink-50 border border-pink-200 rounded-lg p-3">
                                        <div>
                                            <span class="text-sm text-gray-600">${new Date(r.datetime || r.createdAt).toLocaleString()}</span>
                                            <span class="text-xs text-gray-500 ml-2">(${r.type})</span>
                                        </div>
                                        <span class="font-bold text-pink-600">${r.value} mg/dL</span>
                                    </div>
                                `).join('') : `
                                    <p class="text-sm text-gray-500 italic">No blood sugar readings yet</p>
                                `}
                            </div>
                        </div>
                        
                        <!-- Blood-Related Conditions -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-exclamation-triangle mr-2 text-yellow-600"></i> Blood-Related Conditions
                            </h3>
                            
                            <!-- Anemia Section -->
                            <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <label class="flex items-center space-x-2 mb-3">
                                    <input type="checkbox" id="has-anemia" class="form-checkbox text-yellow-600">
                                    <span class="font-semibold">Anemia</span>
                                </label>
                                <div id="anemia-details" class="hidden grid md:grid-cols-3 gap-3 ml-6">
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Severity</label>
                                        <select class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                            <option value="mild">Mild</option>
                                            <option value="moderate">Moderate</option>
                                            <option value="severe">Severe</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Type</label>
                                        <select class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                            <option value="iron">Iron deficiency</option>
                                            <option value="b12">B12 deficiency</option>
                                            <option value="folate">Folate deficiency</option>
                                            <option value="chronic">Chronic disease</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-gray-700 mb-1">Treatment</label>
                                        <input type="text" placeholder="e.g., Iron supplements" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Other Blood Conditions -->
                            <div class="grid md:grid-cols-2 gap-3">
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" class="form-checkbox text-purple-600">
                                    <span class="text-sm">Hemophilia (Bleeding disorder)</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" class="form-checkbox text-purple-600">
                                    <span class="text-sm">Thalassemia</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" class="form-checkbox text-purple-600">
                                    <span class="text-sm">Sickle Cell Disease</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" class="form-checkbox text-purple-600">
                                    <span class="text-sm">Thrombocytopenia (Low platelets)</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" class="form-checkbox text-purple-600">
                                    <span class="text-sm">Polycythemia (High RBC)</span>
                                </label>
                                <label class="flex items-center space-x-2 p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100">
                                    <input type="checkbox" class="form-checkbox text-purple-600">
                                    <span class="text-sm">Von Willebrand Disease</span>
                                </label>
                            </div>
                        </div>
                        
                        <!-- Blood Test Results -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-vial mr-2 text-blue-600"></i> Blood Test Results
                                </h3>
                                <button onclick="addBloodTest()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Add Test
                                </button>
                            </div>
                            
                            <div class="mb-3">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Latest Test Date</label>
                                <input type="date" id="test-date" class="px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Hemoglobin (g/dL)</label>
                                    <input type="number" step="0.1" placeholder="12.5" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 12-16 (F), 14-18 (M)</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Hematocrit (%)</label>
                                    <input type="number" step="0.1" placeholder="38" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 36-46% (F), 41-53% (M)</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">RBC Count (M/L)</label>
                                    <input type="number" step="0.1" placeholder="4.2" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 4.0-5.5</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">WBC Count (/L)</label>
                                    <input type="number" placeholder="7500" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 4,500-11,000</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Platelet Count (k/L)</label>
                                    <input type="number" placeholder="250" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 150-400</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Iron (g/dL)</label>
                                    <input type="number" placeholder="85" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 60-170</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Ferritin (ng/mL)</label>
                                    <input type="number" placeholder="45" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 12-150 (F), 12-300 (M)</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Clotting & Bleeding Profile -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-band-aid mr-2 text-red-600"></i> Clotting & Bleeding Profile
                            </h3>
                            <div class="bg-red-50 border-l-4 border-red-500 p-3 mb-4">
                                <p class="text-sm text-red-800 font-semibold"> Critical for dental procedures - extractions, surgery, implants</p>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Bleeding Tendency</label>
                                    <select class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="normal">Normal</option>
                                        <option value="easy-bruising">Easy bruising</option>
                                        <option value="prolonged">Prolonged bleeding</option>
                                        <option value="spontaneous">Spontaneous bleeding</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Clotting Time (minutes)</label>
                                    <input type="number" placeholder="5" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 2-8 minutes</p>
                                </div>
                            </div>
                            
                            <div class="grid md:grid-cols-3 gap-4">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">PT (seconds)</label>
                                    <input type="number" step="0.1" placeholder="12" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 11-13.5</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">INR</label>
                                    <input type="number" step="0.1" placeholder="1.0" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 0.8-1.2</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">aPTT (seconds)</label>
                                    <input type="number" placeholder="30" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 25-35</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Blood Pressure Trends -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-heartbeat mr-2 text-red-600"></i> Blood Pressure Monitoring
                                </h3>
                                <button onclick="addBPReading()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Add Reading
                                </button>
                            </div>
                            
                            <div class="grid md:grid-cols-3 gap-4 mb-4">
                                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <p class="text-sm text-gray-600 mb-1">Latest Reading</p>
                                    <p class="text-2xl font-bold text-green-600">120/80</p>
                                    <p class="text-xs text-gray-500">Nov 25, 2025</p>
                                </div>
                                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p class="text-sm text-gray-600 mb-1">Average (30 days)</p>
                                    <p class="text-2xl font-bold text-blue-600">118/78</p>
                                    <p class="text-xs text-green-600"> Normal</p>
                                </div>
                                <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                                    <p class="text-sm text-gray-600 mb-1">Total Readings</p>
                                    <p class="text-2xl font-bold text-purple-600">0</p>
                                    <p class="text-xs text-gray-500">This month</p>
                                </div>
                            </div>
                            
                            <div id="bp-history" class="space-y-2">
                                <p class="text-sm text-gray-500 italic">No blood pressure readings yet</p>
                            </div>
                        </div>
                        
                        <!-- Blood Sugar (For Diabetics) -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-candy-cane mr-2 text-pink-600"></i> Blood Sugar Monitoring
                                </h3>
                                <button onclick="addBloodSugar()" class="bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition text-sm font-semibold">
                                    <i class="fas fa-plus mr-2"></i>Add Reading
                                </button>
                            </div>
                            
                            <div class="grid md:grid-cols-3 gap-4">
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Fasting (mg/dL)</label>
                                    <input type="number" placeholder="95" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: 70-100</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">HbA1c (%)</label>
                                    <input type="number" step="0.1" placeholder="5.8" class="w-full px-2 py-1 border border-gray-300 rounded">
                                    <p class="text-xs text-gray-500 mt-1">Normal: <5.7%</p>
                                </div>
                                <div class="p-3 bg-gray-50 rounded-lg">
                                    <label class="block text-xs font-semibold text-gray-700 mb-1">Status</label>
                                    <select class="w-full px-2 py-1 border border-gray-300 rounded">
                                        <option value="normal">Normal</option>
                                        <option value="prediabetic">Pre-diabetic</option>
                                        <option value="diabetic">Diabetic</option>
                                        <option value="controlled">Well controlled</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end">
                            <button onclick="saveBloodProfile()" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition font-semibold">
                                <i class="fas fa-save mr-2"></i>Save Blood Profile
                            </button>
                        </div>
                    </div>
                `;
                
                // Add event listener for anemia checkbox
                setTimeout(() => {
                    const anemiaCheckbox = document.getElementById('has-anemia');
                    if (anemiaCheckbox) {
                        anemiaCheckbox.addEventListener('change', function() {
                            const details = document.getElementById('anemia-details');
                            if (this.checked) {
                                details.classList.remove('hidden');
                            } else {
                                details.classList.add('hidden');
                            }
                        });
                    }
                    
                    // Auto-calculate next eligible donation date
                    const lastDonationInput = document.getElementById('last-donation');
                    if (lastDonationInput) {
                        lastDonationInput.addEventListener('change', function() {
                            if (this.value) {
                                const lastDate = new Date(this.value);
                                const nextDate = new Date(lastDate);
                                nextDate.setDate(nextDate.getDate() + 56); // 8 weeks
                                document.getElementById('next-eligible').value = nextDate.toISOString().split('T')[0];
                            }
                        });
                    }
                }, 100);
            } else if (tabName === 'dental') {
                // Dental Chart Tab
                const teeth = currentPatient?.dentalChart?.teeth || {};
                const getToothColor = (toothNum) => {
                    const condition = teeth[toothNum]?.condition || '';
                    const colors = {
                        '': { icon: 'text-gray-400', border: 'border-gray-300', bg: 'bg-white' },
                        'missing': { icon: 'text-red-500', border: 'border-red-400', bg: 'bg-red-50' },
                        'cavity': { icon: 'text-yellow-500', border: 'border-yellow-400', bg: 'bg-yellow-50' },
                        'filling': { icon: 'text-blue-500', border: 'border-blue-400', bg: 'bg-blue-50' },
                        'crown': { icon: 'text-purple-500', border: 'border-purple-400', bg: 'bg-purple-50' },
                        'root-canal': { icon: 'text-green-500', border: 'border-green-400', bg: 'bg-green-50' },
                        'implant': { icon: 'text-gray-600', border: 'border-gray-500', bg: 'bg-gray-100' },
                        'bridge': { icon: 'text-orange-500', border: 'border-orange-400', bg: 'bg-orange-50' },
                        'attention': { icon: 'text-pink-500', border: 'border-pink-400', bg: 'bg-pink-50' }
                    };
                    return colors[condition] || colors[''];
                };
                
                const renderTooth = (toothNum) => {
                    const color = getToothColor(toothNum);
                    const hasData = teeth[toothNum]?.condition;
                    return `
                        <button onclick="selectTooth(${toothNum})" class="tooth-btn w-12 h-16 ${color.bg} border-2 ${color.border} rounded-lg hover:border-purple-500 hover:shadow-md transition flex flex-col items-center justify-center text-xs font-semibold relative">
                            <i class="fas fa-tooth text-2xl ${color.icon} mb-1"></i>
                            <span class="text-gray-600">${toothNum}</span>
                            ${hasData ? '<div class="absolute -top-1 -right-1 w-3 h-3 bg-purple-500 rounded-full"></div>' : ''}
                        </button>
                    `;
                };
                
                content.innerHTML = `
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center"> Interactive Dental Chart</h3>
                        
                        <div class="mb-8">
                            <h4 class="text-lg font-semibold text-gray-700 mb-4 text-center">Upper Teeth</h4>
                            <div class="flex justify-center space-x-1 md:space-x-2 mb-2 flex-wrap">
                                ${[18,17,16,15,14,13,12,11,21,22,23,24,25,26,27,28].map(tooth => renderTooth(tooth)).join('')}
                            </div>
                            
                            <h4 class="text-lg font-semibold text-gray-700 mb-4 mt-8 text-center">Lower Teeth</h4>
                            <div class="flex justify-center space-x-1 md:space-x-2 flex-wrap">
                                ${[48,47,46,45,44,43,42,41,31,32,33,34,35,36,37,38].map(tooth => renderTooth(tooth)).join('')}
                            </div>
                        </div>
                        
                        <!-- Legend -->
                        <div class="bg-gray-50 rounded-lg p-4 mb-6">
                            <h4 class="font-bold text-gray-800 mb-3">Legend:</h4>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-gray-400"></i><span>Healthy</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-red-500"></i><span>Missing</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-yellow-500"></i><span>Cavity</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-blue-500"></i><span>Filling</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-purple-500"></i><span>Crown</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-green-500"></i><span>Root Canal</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-gray-600"></i><span>Implant</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-orange-500"></i><span>Bridge</span></div>
                                <div class="flex items-center space-x-2"><i class="fas fa-tooth text-pink-500"></i><span>Needs Attention</span></div>
                            </div>
                        </div>
                        
                        <!-- Tooth Details Panel -->
                        <div id="tooth-details" class="bg-blue-50 border border-blue-200 rounded-lg p-4 hidden">
                            <h4 class="font-bold text-blue-800 mb-3">Tooth #<span id="selected-tooth-number"></span> Details</h4>
                            <div class="space-y-3">
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Condition</label>
                                    <select id="tooth-condition" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                        <option value="">Healthy</option>
                                        <option value="missing">Missing</option>
                                        <option value="cavity">Cavity</option>
                                        <option value="filling">Filling</option>
                                        <option value="crown">Crown</option>
                                        <option value="root-canal">Root Canal</option>
                                        <option value="implant">Implant</option>
                                        <option value="bridge">Bridge</option>
                                        <option value="attention">Needs Attention</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-gray-700 mb-2">Notes</label>
                                    <textarea id="tooth-notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg" placeholder="Add notes about this tooth..."></textarea>
                                </div>
                                <div class="flex space-x-2">
                                    <button id="btn-save-tooth" onclick="saveToothData()" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition font-semibold">
                                        <i class="fas fa-save mr-2"></i>Save
                                    </button>
                                    <button onclick="closeToothDetails()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabName === 'files') {
                // Files & Images Tab
                content.innerHTML = `
                    <div class="space-y-6">
                        <!-- X-Rays Section -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-x-ray mr-2 text-blue-600"></i> X-Rays
                                </h3>
                                <button onclick="uploadFile('xray')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition text-sm font-semibold">
                                    <i class="fas fa-upload mr-2"></i>Upload X-Ray
                                </button>
                            </div>
                            <div id="xrays-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center text-gray-400 hover:border-blue-500 hover:text-blue-500 cursor-pointer transition">
                                    <i class="fas fa-plus text-3xl mb-2"></i>
                                    <span class="text-sm">Upload X-Ray</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Intraoral Photos Section -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-camera mr-2 text-green-600"></i> Intraoral Photos
                                </h3>
                                <button onclick="uploadFile('photo')" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm font-semibold">
                                    <i class="fas fa-upload mr-2"></i>Upload Photo
                                </button>
                            </div>
                            <div id="photos-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center text-gray-400 hover:border-green-500 hover:text-green-500 cursor-pointer transition">
                                    <i class="fas fa-plus text-3xl mb-2"></i>
                                    <span class="text-sm">Upload Photo</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Documents Section -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-file-pdf mr-2 text-red-600"></i> Documents
                                </h3>
                                <button onclick="uploadFile('document')" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm font-semibold">
                                    <i class="fas fa-upload mr-2"></i>Upload Document
                                </button>
                            </div>
                            <div id="documents-list" class="space-y-2">
                                <div class="text-sm text-gray-500 italic">No documents uploaded yet</div>
                            </div>
                        </div>
                        
                        <!-- Insurance Cards Section -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                                    <i class="fas fa-id-card mr-2 text-purple-600"></i> Insurance Cards
                                </h3>
                                <button onclick="uploadFile('insurance')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition text-sm font-semibold">
                                    <i class="fas fa-upload mr-2"></i>Upload Card
                                </button>
                            </div>
                            <div id="insurance-grid" class="grid grid-cols-2 gap-4">
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center text-gray-400 hover:border-purple-500 hover:text-purple-500 cursor-pointer transition">
                                    <i class="fas fa-plus text-3xl mb-2"></i>
                                    <span class="text-sm">Front</span>
                                </div>
                                <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 flex flex-col items-center justify-center text-gray-400 hover:border-purple-500 hover:text-purple-500 cursor-pointer transition">
                                    <i class="fas fa-plus text-3xl mb-2"></i>
                                    <span class="text-sm">Back</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabName === 'treatment') {
                // Treatment Plans Tab
                const plans = currentPatient?.treatmentPlans || [];
                const activePlans = plans.filter(p => p.status === 'active');
                const completedPlans = plans.filter(p => p.status === 'completed');
                
                const getProcedureIcon = (status) => {
                    const icons = {
                        'pending': '<i class="fas fa-clock text-gray-400"></i>',
                        'scheduled': '<i class="fas fa-calendar text-blue-500"></i>',
                        'in-progress': '<i class="fas fa-spinner text-yellow-500"></i>',
                        'success': '<i class="fas fa-check-circle text-green-500"></i>',
                        'failed': '<i class="fas fa-times-circle text-red-500"></i>',
                        'cancelled': '<i class="fas fa-ban text-gray-500"></i>'
                    };
                    return icons[status] || icons['pending'];
                };
                
                const renderProcedure = (proc, planId) => `
                    <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3 border border-gray-200">
                        <div class="flex items-center space-x-3">
                            ${getProcedureIcon(proc.status)}
                            <div>
                                <p class="font-semibold text-gray-800">${proc.name}</p>
                                <p class="text-xs text-gray-500">${proc.date ? new Date(proc.date).toLocaleDateString() : 'No date set'} ${proc.notes ? ' ' + proc.notes : ''}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <select onchange="updateProcedureStatus('${planId}', '${proc.id}', this.value)" class="text-xs border border-gray-300 rounded px-2 py-1">
                                <option value="pending" ${proc.status === 'pending' ? 'selected' : ''}>Pending</option>
                                <option value="scheduled" ${proc.status === 'scheduled' ? 'selected' : ''}>Scheduled</option>
                                <option value="in-progress" ${proc.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                <option value="success" ${proc.status === 'success' ? 'selected' : ''}>Success</option>
                                <option value="failed" ${proc.status === 'failed' ? 'selected' : ''}>Failed</option>
                                <option value="cancelled" ${proc.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                            </select>
                            <button onclick="deleteProcedure('${planId}', '${proc.id}')" class="text-red-500 hover:text-red-700 text-sm"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
                
                const renderPlan = (plan, isCompleted = false) => {
                    const procedures = plan.procedures || [];
                    const successCount = procedures.filter(p => p.status === 'success').length;
                    const totalCount = procedures.length;
                    const progress = totalCount > 0 ? Math.round((successCount / totalCount) * 100) : 0;
                    
                    return `
                        <div class="border-2 ${isCompleted ? 'border-green-200 bg-green-50' : 'border-purple-200 bg-purple-50'} rounded-xl p-4">
                            <div class="flex items-center justify-between mb-3">
                                <div>
                                    <h4 class="font-bold text-gray-800 text-lg">${plan.title}</h4>
                                    <p class="text-xs text-gray-500">Created: ${new Date(plan.createdAt).toLocaleDateString()} ${plan.tooth ? ' Tooth #' + plan.tooth : ''}</p>
                                </div>
                                <div class="flex items-center space-x-2">
                                    ${!isCompleted ? `
                                        <button onclick="addProcedure('${plan.id}')" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition text-xs font-semibold"><i class="fas fa-plus mr-1"></i>Add Procedure</button>
                                        <button onclick="completePlan('${plan.id}')" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition text-xs font-semibold"><i class="fas fa-check mr-1"></i>Complete</button>
                                    ` : `
                                        <button onclick="reopenPlan('${plan.id}')" class="bg-yellow-500 text-white px-3 py-1 rounded-lg hover:bg-yellow-600 transition text-xs font-semibold"><i class="fas fa-redo mr-1"></i>Reopen</button>
                                    `}
                                    <button onclick="deletePlan('${plan.id}')" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition text-xs font-semibold"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="mb-3">
                                <div class="flex justify-between text-xs text-gray-600 mb-1">
                                    <span>Progress</span>
                                    <span>${successCount}/${totalCount} procedures (${progress}%)</span>
                                </div>
                                <div class="w-full bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-500 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                                </div>
                            </div>
                            
                            <!-- Procedures List -->
                            <div class="space-y-2">
                                ${procedures.length > 0 ? procedures.map(proc => renderProcedure(proc, plan.id)).join('') : '<p class="text-sm text-gray-500 italic text-center py-2">No procedures added yet</p>'}
                            </div>
                        </div>
                    `;
                };
                
                content.innerHTML = `
                    <div class="space-y-6">
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <div class="flex items-center justify-between mb-4">
                                <h3 class="text-lg font-bold text-gray-800 flex items-center"><i class="fas fa-procedures mr-2 text-green-600"></i> Active Treatment Plans (${activePlans.length})</h3>
                                <button onclick="createTreatmentPlan()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition text-sm font-semibold"><i class="fas fa-plus mr-2"></i>New Plan</button>
                            </div>
                            <div id="active-plans" class="space-y-4">
                                ${activePlans.length > 0 ? activePlans.map(plan => renderPlan(plan, false)).join('') : '<div class="text-sm text-gray-500 italic text-center py-8">No active treatment plans</div>'}
                            </div>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center"><i class="fas fa-check-circle mr-2 text-blue-600"></i> Completed Treatment Plans (${completedPlans.length})</h3>
                            <div id="completed-plans" class="space-y-4">
                                ${completedPlans.length > 0 ? completedPlans.map(plan => renderPlan(plan, true)).join('') : '<div class="text-sm text-gray-500 italic">No completed treatment plans</div>'}
                            </div>
                        </div>
                    </div>
                `;
            } else if (tabName === 'forms') {
                // Forms & Documents Tab
                content.innerHTML = `
                    <div class="space-y-6">
                        <!-- Send Form Section -->
                        <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                            <h3 class="text-xl font-bold mb-4"> Send Form to Patient</h3>
                            <p class="mb-4 opacity-90">Generate a unique link and send it to the patient via SMS or Email. They can fill it out on their phone!</p>
                            <div class="grid md:grid-cols-2 gap-4">
                                <button onclick="sendFormLink('medical', '${currentPatient.id}', '${currentPatient.phone || currentPatient.email}', '${currentPatient.name}')" class="bg-white text-purple-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-semibold">
                                    <i class="fas fa-heartbeat mr-2"></i>Medical History Form
                                </button>
                                <button onclick="sendFormLink('consent', '${currentPatient.id}', '${currentPatient.phone || currentPatient.email}', '${currentPatient.name}')" class="bg-white text-purple-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-semibold">
                                    <i class="fas fa-file-signature mr-2"></i>Consent Form
                                </button>
                                <button onclick="sendFormLink('insurance', '${currentPatient.id}', '${currentPatient.phone || currentPatient.email}', '${currentPatient.name}')" class="bg-white text-purple-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-semibold">
                                    <i class="fas fa-id-card mr-2"></i>Insurance Form
                                </button>
                                <button onclick="sendFormLink('feedback', '${currentPatient.id}', '${currentPatient.phone || currentPatient.email}', '${currentPatient.name}')" class="bg-white text-purple-600 px-6 py-3 rounded-lg hover:bg-gray-100 transition font-semibold">
                                    <i class="fas fa-star mr-2"></i>Feedback Survey
                                </button>
                            </div>
                        </div>
                        
                        <!-- Completed Forms -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-check-circle mr-2 text-green-600"></i> Completed Forms
                            </h3>
                            <div id="completed-forms" class="space-y-2">
                                <div class="text-sm text-gray-500 italic">No forms completed yet</div>
                            </div>
                        </div>
                        
                        <!-- Pending Forms -->
                        <div class="bg-white rounded-xl shadow-lg p-6">
                            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-clock mr-2 text-yellow-600"></i> Pending Forms
                            </h3>
                            <div id="pending-forms" class="space-y-2">
                                <div class="text-sm text-gray-500 italic">No pending forms</div>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function exportPatients() {
            // Simple CSV export
            let csv = 'Patient ID,Name,Email,Phone,Total Visits,Last Visit,Status\n';
            allPatients.forEach(p => {
                csv += `${p.id},"${p.name}","${p.email}","${p.phone}",${p.totalVisits},${p.lastVisit},${p.status}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `patients_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('Patient data exported successfully', 'success');
        }
        
        // ========== PATIENT PROFILE HELPER FUNCTIONS ==========
        
        // Modern Modal Input (replaces browser prompt)
        function showInputModal(title, placeholder, buttonText, callback) {
            // Remove focus from any currently focused element
            if (document.activeElement) document.activeElement.blur();
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'input-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all">
                    <div class="bg-gradient-to-r from-purple-600 to-indigo-600 px-6 py-4">
                        <h3 class="text-xl font-bold text-white">${title}</h3>
                    </div>
                    <div class="p-6">
                        <input type="text" id="modal-input-value" placeholder="${placeholder}" 
                            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition-all outline-none text-gray-700">
                        <div class="flex space-x-3 mt-6">
                            <button id="modal-submit-btn" onclick="submitModalInput()" class="flex-1 bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-6 py-3 rounded-xl hover:from-purple-700 hover:to-indigo-700 transition-all font-semibold shadow-lg">
                                <i class="fas fa-check mr-2"></i>${buttonText}
                            </button>
                            <button id="modal-cancel-btn" onclick="closeInputModal()" class="flex-1 bg-gray-100 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-200 transition-all font-semibold">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus input after a short delay
            setTimeout(() => {
                const input = document.getElementById('modal-input-value');
                if (input) input.focus();
            }, 50);
            
            // Store callback
            window.modalInputCallback = callback;
            
            // Enter key handler
            document.getElementById('modal-input-value').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') submitModalInput();
            });
        }
        
        async function submitModalInput() {
            const value = document.getElementById('modal-input-value').value.trim();
            if (!value) {
                closeInputModal();
                return;
            }
            
            // Show loading state
            const btn = document.getElementById('modal-submit-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            cancelBtn.disabled = true;
            
            const callback = window.modalInputCallback;
            try {
                if (callback) await callback(value);
            } finally {
                closeInputModal();
            }
        }
        
        function closeInputModal() {
            const modal = document.getElementById('input-modal');
            if (modal) modal.remove();
            window.modalInputCallback = null;
        }
        
        // Helper: Ensure patient exists in Firestore
        async function ensurePatientInFirestore() {
            if (!currentPatient) {
                showToast(' No patient selected', 'error');
                return null;
            }
            
            // If patient already has firestoreId, return it
            if (currentPatient.firestoreId) {
                return currentPatient.firestoreId;
            }
            
            // Try to find existing patient by phone or email first
            try {
                let existingPatient = null;
                
                if (currentPatient.phone) {
                    const phoneQuery = await db.collection('patients').where('phone', '==', currentPatient.phone).limit(1).get();
                    if (!phoneQuery.empty) existingPatient = phoneQuery.docs[0];
                }
                
                if (!existingPatient && currentPatient.email) {
                    const emailQuery = await db.collection('patients').where('email', '==', currentPatient.email).limit(1).get();
                    if (!emailQuery.empty) existingPatient = emailQuery.docs[0];
                }
                
                if (existingPatient) {
                    currentPatient.firestoreId = existingPatient.id;
                    // Load existing data
                    const data = existingPatient.data();
                    currentPatient.medicalHistory = data.medicalHistory || {};
                    currentPatient.bloodProfile = data.bloodProfile || {};
                    currentPatient.dentalChart = data.dentalChart || {};
                    currentPatient.treatmentPlans = data.treatmentPlans || [];
                    currentPatient.files = data.files || {};
                    
                    // Update allPatients array
                    const idx = allPatients.findIndex(p => p.id === currentPatient.id);
                    if (idx !== -1) allPatients[idx].firestoreId = existingPatient.id;
                    
                    console.log(' Found existing patient in Firestore:', existingPatient.id);
                    return existingPatient.id;
                }
                
                // Create new patient record in Firestore
                const newPatientRef = await db.collection('patients').add({
                    name: currentPatient.name,
                    email: currentPatient.email,
                    phone: currentPatient.phone,
                    medicalHistory: {},
                    bloodProfile: {},
                    dentalChart: { teeth: {} },
                    treatmentPlans: [],
                    files: { xrays: [], photos: [], documents: [], insurance: [] },
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                currentPatient.firestoreId = newPatientRef.id;
                
                // Update allPatients array so it persists
                const idx = allPatients.findIndex(p => p.id === currentPatient.id);
                if (idx !== -1) allPatients[idx].firestoreId = newPatientRef.id;
                
                console.log(' Created new patient in Firestore:', newPatientRef.id);
                return newPatientRef.id;
            } catch (error) {
                console.error('Error creating patient:', error);
                showToast(' Error creating patient record', 'error');
                return null;
            }
        }
        
        // Medical History Functions
        function sendMedicalForm(contact) {
            const formId = Math.random().toString(36).substr(2, 9);
            const formLink = `https://clinic-one-zeta.vercel.app/form/?type=medical&id=${formId}&contact=${encodeURIComponent(contact)}`;
            showToast(` Form link generated: ${formLink}`, 'success');
            console.log('Send medical form to:', contact, 'Link:', formLink);
        }
        
        function addAllergy() {
            showInputModal(' Add Allergy', 'Enter allergy name (e.g., Penicillin, Peanuts)', 'Add Allergy', async (allergy) => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    await db.collection('patients').doc(patientId).update({
                        'medicalHistory.allergies': firebase.firestore.FieldValue.arrayUnion(allergy),
                        'medicalHistory.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local state
                    if (!currentPatient.medicalHistory) currentPatient.medicalHistory = {};
                    if (!currentPatient.medicalHistory.allergies) currentPatient.medicalHistory.allergies = [];
                    currentPatient.medicalHistory.allergies.push(allergy);
                    
                    const allergiesList = document.getElementById('allergies-list');
                    if (allergiesList) {
                        allergiesList.innerHTML = currentPatient.medicalHistory.allergies.map(a => `
                            <div class="flex items-center justify-between bg-red-50 border border-red-200 rounded-lg p-3">
                                <span class="text-sm text-red-800 font-semibold"> ${a}</span>
                                <button onclick="removeAllergy('${a}')" class="text-red-600 hover:text-red-800"><i class="fas fa-times"></i></button>
                            </div>
                        `).join('');
                    }
                    
                    showToast(` Added allergy: ${allergy}`, 'success');
                } catch (error) {
                    console.error('Error adding allergy:', error);
                    showToast(' Error adding allergy', 'error');
                }
            });
        }
        
        async function removeAllergy(allergy) {
            const patientId = currentPatient?.firestoreId;
            if (!patientId) return;
            
            try {
                await db.collection('patients').doc(patientId).update({
                    'medicalHistory.allergies': firebase.firestore.FieldValue.arrayRemove(allergy)
                });
                
                currentPatient.medicalHistory.allergies = currentPatient.medicalHistory.allergies.filter(a => a !== allergy);
                showPatientTab('medical'); // Refresh tab
                showToast(` Removed allergy: ${allergy}`, 'success');
            } catch (error) {
                console.error('Error removing allergy:', error);
                showToast(' Error removing allergy', 'error');
            }
        }
        
        function addMedication() {
            showInputModal(' Add Medication', 'Enter medication name and dosage (e.g., Metformin 500mg)', 'Add Medication', async (medication) => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    await db.collection('patients').doc(patientId).update({
                        'medicalHistory.medications': firebase.firestore.FieldValue.arrayUnion(medication),
                        'medicalHistory.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Update local state
                    if (!currentPatient.medicalHistory) currentPatient.medicalHistory = {};
                    if (!currentPatient.medicalHistory.medications) currentPatient.medicalHistory.medications = [];
                    currentPatient.medicalHistory.medications.push(medication);
                    
                    const medicationsList = document.getElementById('medications-list');
                    if (medicationsList) {
                        medicationsList.innerHTML = currentPatient.medicalHistory.medications.map(m => `
                            <div class="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <span class="text-sm text-blue-800"> ${m}</span>
                                <button onclick="removeMedication('${m}')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-times"></i></button>
                            </div>
                        `).join('');
                    }
                    
                    showToast(` Added medication: ${medication}`, 'success');
                } catch (error) {
                    console.error('Error adding medication:', error);
                    showToast(' Error adding medication', 'error');
                }
            });
        }
        
        async function removeMedication(medication) {
            const patientId = currentPatient?.firestoreId;
            if (!patientId) return;
            
            try {
                await db.collection('patients').doc(patientId).update({
                    'medicalHistory.medications': firebase.firestore.FieldValue.arrayRemove(medication)
                });
                
                currentPatient.medicalHistory.medications = currentPatient.medicalHistory.medications.filter(m => m !== medication);
                showPatientTab('medical');
                showToast(` Removed medication: ${medication}`, 'success');
            } catch (error) {
                console.error('Error removing medication:', error);
                showToast(' Error removing medication', 'error');
            }
        }
        
        function addCustomCondition() {
            showInputModal(' Add Medical Condition', 'Enter custom medical condition', 'Add Condition', async (condition) => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    await db.collection('patients').doc(patientId).update({
                        'medicalHistory.conditions': firebase.firestore.FieldValue.arrayUnion(condition),
                        'medicalHistory.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    if (!currentPatient.medicalHistory.conditions) currentPatient.medicalHistory.conditions = [];
                    currentPatient.medicalHistory.conditions.push(condition);
                    
                    showToast(` Added condition: ${condition}`, 'success');
                } catch (error) {
                    console.error('Error adding condition:', error);
                    showToast(' Error adding condition', 'error');
                }
            });
        }
        
        async function saveMedicalHistory() {
            const btn = document.getElementById('btn-save-medical');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) {
                btn.innerHTML = originalText;
                btn.disabled = false;
                return;
            }
            
            try {
                // Collect all checkbox conditions
                const conditions = [];
                document.querySelectorAll('#medical-conditions-list input[type="checkbox"]:checked').forEach(cb => {
                    conditions.push(cb.value);
                });
                
                // Get vital info (Blood Type is now in Blood Profile tab)
                const bloodPressure = document.getElementById('vital-blood-pressure')?.value || '';
                const emergencyContact = document.getElementById('vital-emergency-contact')?.value || '';
                
                // Get dental concerns
                const dentalConcerns = [];
                document.querySelectorAll('#dental-concerns-list input[type="checkbox"]:checked').forEach(cb => {
                    dentalConcerns.push(cb.value);
                });
                
                await db.collection('patients').doc(patientId).update({
                    'medicalHistory.conditions': conditions,
                    'medicalHistory.bloodPressure': bloodPressure,
                    'medicalHistory.emergencyContact': emergencyContact,
                    'medicalHistory.dentalConcerns': dentalConcerns,
                    'medicalHistory.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local data so tab switching reflects changes immediately
                if (!currentPatient.medicalHistory) currentPatient.medicalHistory = {};
                currentPatient.medicalHistory.conditions = conditions;
                currentPatient.medicalHistory.bloodPressure = bloodPressure;
                currentPatient.medicalHistory.emergencyContact = emergencyContact;
                currentPatient.medicalHistory.dentalConcerns = dentalConcerns;
                
                showToast(' Medical history saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving medical history:', error);
                showToast(' Error saving medical history', 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Dental Chart Functions
        let selectedToothNumber = null;
        
        function selectTooth(toothNumber) {
            selectedToothNumber = toothNumber;
            document.getElementById('selected-tooth-number').textContent = toothNumber;
            document.getElementById('tooth-details').classList.remove('hidden');
            
            // Load existing tooth data
            const toothData = currentPatient?.dentalChart?.teeth?.[toothNumber];
            if (toothData) {
                document.getElementById('tooth-condition').value = toothData.condition || '';
                document.getElementById('tooth-notes').value = toothData.notes || '';
            } else {
                document.getElementById('tooth-condition').value = '';
                document.getElementById('tooth-notes').value = '';
            }
        }
        
        async function saveToothData() {
            const condition = document.getElementById('tooth-condition').value;
            const notes = document.getElementById('tooth-notes').value;
            
            // Show loading
            const btn = document.getElementById('btn-save-tooth');
            if (btn) {
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                btn.disabled = true;
            }
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) return;
            
            try {
                await db.collection('patients').doc(patientId).update({
                    [`dentalChart.teeth.${selectedToothNumber}`]: {
                        condition: condition,
                        notes: notes,
                        updatedAt: new Date().toISOString()
                    },
                    'dentalChart.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local data
                if (!currentPatient.dentalChart) currentPatient.dentalChart = { teeth: {} };
                if (!currentPatient.dentalChart.teeth) currentPatient.dentalChart.teeth = {};
                currentPatient.dentalChart.teeth[selectedToothNumber] = { condition, notes };
                
                showToast(` Saved data for tooth #${selectedToothNumber}`, 'success');
                closeToothDetails();
                
                // Refresh the dental chart to show updated colors
                showPatientTab('dental');
            } catch (error) {
                console.error('Error saving tooth data:', error);
                showToast(' Error saving tooth data', 'error');
                if (btn) {
                    btn.innerHTML = '<i class="fas fa-save mr-2"></i>Save';
                    btn.disabled = false;
                }
            }
        }
        
        function closeToothDetails() {
            document.getElementById('tooth-details').classList.add('hidden');
            document.getElementById('tooth-condition').value = '';
            document.getElementById('tooth-notes').value = '';
            selectedToothNumber = null;
        }
        
        // File Upload Functions (Placeholder - requires Firebase Storage Pro)
        function uploadFile(fileType) {
            showToast(` File upload requires Firebase Storage (Pro feature). File type: ${fileType}`, 'info');
        }
        
        // Treatment Plan Functions
        function createTreatmentPlan() {
            showInputModal(' Create Treatment Plan', 'Enter treatment plan title (e.g., Root Canal Treatment)', 'Create Plan', async (title) => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                try {
                    const newPlan = { id: `plan-${Date.now()}`, title, status: 'active', createdAt: new Date().toISOString(), procedures: [] };
                    await db.collection('patients').doc(patientId).update({
                        treatmentPlans: firebase.firestore.FieldValue.arrayUnion(newPlan)
                    });
                    if (!currentPatient.treatmentPlans) currentPatient.treatmentPlans = [];
                    currentPatient.treatmentPlans.push(newPlan);
                    showPatientTab('treatment');
                    showToast(` Created treatment plan: ${title}`, 'success');
                } catch (error) {
                    showToast(' Error creating treatment plan', 'error');
                }
            });
        }
        
        function addProcedure(planId) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.id = 'procedure-modal';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800"> Add Procedure</h3>
                        <button onclick="closeProcedureModal()" class="text-gray-400 hover:text-gray-600 text-2xl"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Procedure Name</label>
                            <input type="text" id="proc-name" placeholder="e.g., X-Ray, Cleaning, Extraction" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Scheduled Date (Optional)</label>
                            <input type="date" id="proc-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Notes (Optional)</label>
                            <input type="text" id="proc-notes" placeholder="Additional notes..." class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Initial Status</label>
                            <select id="proc-status" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="pending">Pending</option>
                                <option value="scheduled">Scheduled</option>
                                <option value="in-progress">In Progress</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex space-x-2 mt-6">
                        <button id="proc-save-btn" onclick="saveProcedure('${planId}')" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition font-semibold"><i class="fas fa-save mr-2"></i>Add Procedure</button>
                        <button onclick="closeProcedureModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function closeProcedureModal() {
            const modal = document.getElementById('procedure-modal');
            if (modal) modal.remove();
        }
        
        async function saveProcedure(planId) {
            const name = document.getElementById('proc-name').value.trim();
            if (!name) { showToast(' Please enter procedure name', 'error'); return; }
            
            const date = document.getElementById('proc-date').value;
            const notes = document.getElementById('proc-notes').value.trim();
            const status = document.getElementById('proc-status').value;
            
            // Show loading
            const btn = document.getElementById('proc-save-btn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            btn.disabled = true;
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) { closeProcedureModal(); return; }
            
            try {
                const newProcedure = { id: `proc-${Date.now()}`, name, date, notes, status, createdAt: new Date().toISOString() };
                
                // Find and update the plan
                const planIndex = currentPatient.treatmentPlans.findIndex(p => p.id === planId);
                if (planIndex === -1) throw new Error('Plan not found');
                
                if (!currentPatient.treatmentPlans[planIndex].procedures) {
                    currentPatient.treatmentPlans[planIndex].procedures = [];
                }
                currentPatient.treatmentPlans[planIndex].procedures.push(newProcedure);
                
                // Save to Firestore
                await db.collection('patients').doc(patientId).update({
                    treatmentPlans: currentPatient.treatmentPlans,
                    'treatmentPlans.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                closeProcedureModal();
                showPatientTab('treatment');
                showToast(` Added procedure: ${name}`, 'success');
            } catch (error) {
                console.error('Error adding procedure:', error);
                showToast(' Error adding procedure', 'error');
                closeProcedureModal();
            }
        }
        
        async function updateProcedureStatus(planId, procId, newStatus) {
            const patientId = await ensurePatientInFirestore();
            if (!patientId) return;
            
            try {
                const planIndex = currentPatient.treatmentPlans.findIndex(p => p.id === planId);
                if (planIndex === -1) return;
                
                const procIndex = currentPatient.treatmentPlans[planIndex].procedures.findIndex(p => p.id === procId);
                if (procIndex === -1) return;
                
                currentPatient.treatmentPlans[planIndex].procedures[procIndex].status = newStatus;
                currentPatient.treatmentPlans[planIndex].procedures[procIndex].updatedAt = new Date().toISOString();
                
                await db.collection('patients').doc(patientId).update({
                    treatmentPlans: currentPatient.treatmentPlans
                });
                
                showPatientTab('treatment');
                showToast(` Status updated to: ${newStatus}`, 'success');
            } catch (error) {
                console.error('Error updating procedure status:', error);
                showToast(' Error updating status', 'error');
            }
        }
        
        function deleteProcedure(planId, procId) {
            showConfirmModal('Delete Procedure', 'Are you sure you want to delete this procedure?', async () => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    const planIndex = currentPatient.treatmentPlans.findIndex(p => p.id === planId);
                    if (planIndex === -1) return;
                    
                    currentPatient.treatmentPlans[planIndex].procedures = currentPatient.treatmentPlans[planIndex].procedures.filter(p => p.id !== procId);
                    
                    await db.collection('patients').doc(patientId).update({
                        treatmentPlans: currentPatient.treatmentPlans
                    });
                    
                    showPatientTab('treatment');
                    showToast(' Procedure deleted', 'success');
                } catch (error) {
                    console.error('Error deleting procedure:', error);
                    showToast(' Error deleting procedure', 'error');
                }
            }, 'Delete', 'red');
        }
        
        function completePlan(planId) {
            showConfirmModal('Complete Plan', 'Mark this treatment plan as completed?', async () => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    const planIndex = currentPatient.treatmentPlans.findIndex(p => p.id === planId);
                    if (planIndex === -1) return;
                    
                    currentPatient.treatmentPlans[planIndex].status = 'completed';
                    currentPatient.treatmentPlans[planIndex].completedAt = new Date().toISOString();
                    
                    await db.collection('patients').doc(patientId).update({
                        treatmentPlans: currentPatient.treatmentPlans
                    });
                    
                    showPatientTab('treatment');
                    showToast(' Treatment plan completed!', 'success');
                } catch (error) {
                    console.error('Error completing plan:', error);
                    showToast(' Error completing plan', 'error');
                }
            }, 'Complete', 'green');
        }
        
        function reopenPlan(planId) {
            showConfirmModal('Reopen Plan', 'Reopen this treatment plan?', async () => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    const planIndex = currentPatient.treatmentPlans.findIndex(p => p.id === planId);
                    if (planIndex === -1) return;
                    
                    currentPatient.treatmentPlans[planIndex].status = 'active';
                    delete currentPatient.treatmentPlans[planIndex].completedAt;
                    
                    await db.collection('patients').doc(patientId).update({
                        treatmentPlans: currentPatient.treatmentPlans
                    });
                    
                    showPatientTab('treatment');
                    showToast(' Treatment plan reopened', 'success');
                } catch (error) {
                    console.error('Error reopening plan:', error);
                    showToast(' Error reopening plan', 'error');
                }
            }, 'Reopen', 'yellow');
        }
        
        function deletePlan(planId) {
            showConfirmModal('Delete Treatment Plan', 'Delete this entire treatment plan? This cannot be undone.', async () => {
                const patientId = await ensurePatientInFirestore();
                if (!patientId) return;
                
                try {
                    currentPatient.treatmentPlans = currentPatient.treatmentPlans.filter(p => p.id !== planId);
                    
                    await db.collection('patients').doc(patientId).update({
                        treatmentPlans: currentPatient.treatmentPlans
                    });
                    
                    showPatientTab('treatment');
                    showToast(' Treatment plan deleted', 'success');
                } catch (error) {
                    console.error('Error deleting plan:', error);
                    showToast(' Error deleting plan', 'error');
                }
            }, 'Delete', 'red');
        }
        
        // Form Link Functions
        function sendFormLink(formType, patientId, contact, patientName) {
            const formId = Math.random().toString(36).substr(2, 9);
            const formLink = `https://clinic-one-zeta.vercel.app/form/?type=${formType}&id=${formId}&patientId=${patientId}&contact=${encodeURIComponent(contact)}&name=${encodeURIComponent(patientName)}`;
            
            // Show modal with link and QR code
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800"> Send ${formType.charAt(0).toUpperCase() + formType.slice(1)} Form</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Form Link</label>
                        <div class="flex space-x-2">
                            <input type="text" value="${formLink}" readonly class="flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm">
                            <button onclick="navigator.clipboard.writeText('${formLink}'); showToast(' Link copied!', 'success')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-4 text-center">
                        <p class="text-sm text-gray-600 mb-3">Patient can scan this QR code:</p>
                        <div class="inline-block bg-gray-100 p-4 rounded-lg">
                            <div class="w-48 h-48 bg-white border-2 border-gray-300 rounded-lg flex items-center justify-center">
                                <div class="text-center">
                                    <i class="fas fa-qrcode text-6xl text-gray-400 mb-2"></i>
                                    <p class="text-xs text-gray-500">QR Code</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="sendViaSMS('${contact}', '${formLink}')" class="bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition font-semibold">
                            <i class="fas fa-sms mr-2"></i>Send SMS
                        </button>
                        <button onclick="sendViaEmail('${contact}', '${formLink}')" class="bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                            <i class="fas fa-envelope mr-2"></i>Send Email
                        </button>
                    </div>
                    
                    <button onclick="this.closest('.fixed').remove()" class="w-full mt-3 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">
                        Close
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function sendViaSMS(contact, link) {
            showToast(` SMS sent to ${contact}`, 'success');
            // TODO: Implement SMS sending via Twilio or similar
        }
        
        function sendViaEmail(contact, link) {
            showToast(` Email sent to ${contact}`, 'success');
            // TODO: Implement email sending
        }
        
        // ========== BLOOD PROFILE HELPER FUNCTIONS ==========
        
        function addDonationRecord() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800"> Add Donation Record</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Donation Date</label>
                            <input type="date" id="donation-date" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Location</label>
                            <input type="text" id="donation-location" placeholder="e.g., Red Cross Manila" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Volume (ml)</label>
                            <input type="number" id="donation-volume" value="450" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Type</label>
                            <select id="donation-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="whole">Whole Blood</option>
                                <option value="plasma">Plasma</option>
                                <option value="platelets">Platelets</option>
                                <option value="double-red">Double Red Cells</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 mt-6">
                        <button onclick="saveDonationRecord()" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition font-semibold">
                            <i class="fas fa-save mr-2"></i>Save
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function saveDonationRecord() {
            const date = document.getElementById('donation-date').value;
            const location = document.getElementById('donation-location').value;
            const volume = document.getElementById('donation-volume').value;
            const type = document.getElementById('donation-type').value;
            
            if (!date) {
                showToast(' Please enter donation date', 'error');
                return;
            }
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) return;
            
            try {
                const donation = {
                    id: `donation-${Date.now()}`,
                    date: date,
                    location: location,
                    volume: parseInt(volume) || 450,
                    type: type,
                    createdAt: new Date().toISOString()
                };
                
                await db.collection('patients').doc(patientId).update({
                    'bloodProfile.donations': firebase.firestore.FieldValue.arrayUnion(donation),
                    'bloodProfile.lastDonation': date,
                    'bloodProfile.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (!currentPatient.bloodProfile) currentPatient.bloodProfile = {};
                if (!currentPatient.bloodProfile.donations) currentPatient.bloodProfile.donations = [];
                currentPatient.bloodProfile.donations.push(donation);
                currentPatient.bloodProfile.lastDonation = date;
                
                document.querySelector('.fixed').remove();
                showPatientTab('blood'); // Refresh tab
                showToast(' Donation record saved!', 'success');
            } catch (error) {
                console.error('Error saving donation:', error);
                showToast(' Error saving donation record', 'error');
            }
        }
        
        function addBloodTest() {
            showToast(' Blood test form ready - fill in the values above', 'info');
        }
        
        function addBPReading() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800"> Add Blood Pressure Reading</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Date & Time</label>
                            <input type="datetime-local" id="bp-datetime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Systolic</label>
                                <input type="number" id="bp-systolic" placeholder="120" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">Diastolic</label>
                                <input type="number" id="bp-diastolic" placeholder="80" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Notes (optional)</label>
                            <textarea id="bp-notes" rows="2" placeholder="e.g., After exercise, Before medication" class="w-full px-3 py-2 border border-gray-300 rounded-lg"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 mt-6">
                        <button onclick="saveBPReading()" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition font-semibold">
                            <i class="fas fa-save mr-2"></i>Save
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function saveBPReading() {
            const datetime = document.getElementById('bp-datetime').value;
            const systolic = document.getElementById('bp-systolic').value;
            const diastolic = document.getElementById('bp-diastolic').value;
            const notes = document.getElementById('bp-notes').value;
            
            if (!systolic || !diastolic) {
                showToast(' Please enter systolic and diastolic values', 'error');
                return;
            }
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) return;
            
            try {
                const reading = {
                    id: `bp-${Date.now()}`,
                    datetime: datetime || new Date().toISOString(),
                    systolic: parseInt(systolic),
                    diastolic: parseInt(diastolic),
                    notes: notes,
                    createdAt: new Date().toISOString()
                };
                
                await db.collection('patients').doc(patientId).update({
                    'bloodProfile.bpReadings': firebase.firestore.FieldValue.arrayUnion(reading),
                    'bloodProfile.latestBP': `${systolic}/${diastolic}`,
                    'bloodProfile.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (!currentPatient.bloodProfile) currentPatient.bloodProfile = {};
                if (!currentPatient.bloodProfile.bpReadings) currentPatient.bloodProfile.bpReadings = [];
                currentPatient.bloodProfile.bpReadings.push(reading);
                currentPatient.bloodProfile.latestBP = `${systolic}/${diastolic}`;
                
                document.querySelector('.fixed').remove();
                showPatientTab('blood'); // Refresh tab
                showToast(` Blood pressure ${systolic}/${diastolic} saved!`, 'success');
            } catch (error) {
                console.error('Error saving BP reading:', error);
                showToast(' Error saving blood pressure', 'error');
            }
        }
        
        function addBloodSugar() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold text-gray-800"> Add Blood Sugar Reading</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 text-2xl">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Date & Time</label>
                            <input type="datetime-local" id="sugar-datetime" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Reading Type</label>
                            <select id="sugar-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                <option value="fasting">Fasting</option>
                                <option value="random">Random</option>
                                <option value="post-meal">Post-meal (2 hours)</option>
                                <option value="bedtime">Bedtime</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Blood Sugar (mg/dL)</label>
                            <input type="number" id="sugar-value" placeholder="95" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                    
                    <div class="flex space-x-2 mt-6">
                        <button onclick="saveBloodSugar()" class="flex-1 bg-pink-600 text-white px-4 py-2 rounded-lg hover:bg-pink-700 transition font-semibold">
                            <i class="fas fa-save mr-2"></i>Save
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition font-semibold">
                            Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        async function saveBloodSugar() {
            const datetime = document.getElementById('sugar-datetime').value;
            const type = document.getElementById('sugar-type').value;
            const value = document.getElementById('sugar-value').value;
            
            if (!value) {
                showToast(' Please enter blood sugar value', 'error');
                return;
            }
            
            const patientId = await ensurePatientInFirestore();
            if (!patientId) return;
            
            try {
                const reading = {
                    id: `sugar-${Date.now()}`,
                    datetime: datetime || new Date().toISOString(),
                    type: type,
                    value: parseInt(value),
                    createdAt: new Date().toISOString()
                };
                
                await db.collection('patients').doc(patientId).update({
                    'bloodProfile.sugarReadings': firebase.firestore.FieldValue.arrayUnion(reading),
                    'bloodProfile.latestSugar': parseInt(value),
                    'bloodProfile.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                if (!currentPatient.bloodProfile) currentPatient.bloodProfile = {};
                if (!currentPatient.bloodProfile.sugarReadings) currentPatient.bloodProfile.sugarReadings = [];
                currentPatient.bloodProfile.sugarReadings.push(reading);
                currentPatient.bloodProfile.latestSugar = parseInt(value);
                
                document.querySelector('.fixed').remove();
                showPatientTab('blood'); // Refresh tab
                showToast(` Blood sugar ${value} mg/dL saved!`, 'success');
            } catch (error) {
                console.error('Error saving blood sugar:', error);
                showToast(' Error saving blood sugar', 'error');
            }
        }
        
        async function saveBloodProfile() {
            const patientId = await ensurePatientInFirestore();
            if (!patientId) return;
            
            try {
                const bloodType = document.getElementById('blood-type')?.value || '';
                const rhFactor = document.getElementById('rh-factor')?.value || '';
                const verified = document.getElementById('blood-verified')?.checked || false;
                
                // Get blood conditions
                const conditions = [];
                document.querySelectorAll('#blood-conditions-list input[type="checkbox"]:checked').forEach(cb => {
                    conditions.push(cb.value);
                });
                
                await db.collection('patients').doc(patientId).update({
                    'bloodProfile.bloodType': bloodType,
                    'bloodProfile.rhFactor': rhFactor,
                    'bloodProfile.verified': verified,
                    'bloodProfile.conditions': conditions,
                    'bloodProfile.updatedAt': firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Update local data
                if (!currentPatient.bloodProfile) currentPatient.bloodProfile = {};
                currentPatient.bloodProfile.bloodType = bloodType;
                currentPatient.bloodProfile.rhFactor = rhFactor;
                currentPatient.bloodProfile.verified = verified;
                currentPatient.bloodProfile.conditions = conditions;
                
                showToast(' Blood profile saved successfully!', 'success');
            } catch (error) {
                console.error('Error saving blood profile:', error);
                showToast(' Error saving blood profile', 'error');
            }
        }
        
        // ========== VIEW FUNCTIONS (Doctors, Staff, Appointments) ==========
        
        async function loadDoctors() {
            try {
                const filterClinic = document.getElementById('filter-clinic-doctors').value;
                let query = db.collection('users').where('role', '==', 'doctor');
                
                // Note: Can't filter by clinicId in query if we need to support both single and array
                // Will filter in memory instead
                
                const snapshot = await query.get();
                let doctors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Filter by clinic if needed (support both clinicId and clinicIds)
                if (filterClinic) {
                    doctors = doctors.filter(doc => {
                        if (doc.clinicId === filterClinic) return true;
                        if (doc.clinicIds && doc.clinicIds.includes(filterClinic)) return true;
                        return false;
                    });
                }
                
                const container = document.getElementById('doctors-grid');
                container.innerHTML = '';
                
                if (doctors.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500">No doctors found</p></div>';
                    return;
                }
                
                for (const doctor of doctors) {
                    let clinicData = [];
                    let isMultiClinic = false;
                    
                    // Support both single clinicId and array clinicIds
                    if (doctor.clinicIds && doctor.clinicIds.length > 0) {
                        // Multi-clinic doctor
                        const clinicPromises = doctor.clinicIds.map(id => db.collection('clinics').doc(id).get());
                        const clinicDocs = await Promise.all(clinicPromises);
                        clinicData = clinicDocs
                            .filter(d => d.exists)
                            .map(d => ({ id: d.id, name: d.data().name }));
                        isMultiClinic = clinicData.length > 1;
                    } else if (doctor.clinicId) {
                        // Single clinic doctor
                        const clinicDoc = await db.collection('clinics').doc(doctor.clinicId).get();
                        if (clinicDoc.exists) {
                            clinicData = [{ id: clinicDoc.id, name: clinicDoc.data().name }];
                        }
                    }
                    
                    // Create clinic pills HTML
                    const clinicPills = clinicData.length > 0
                        ? clinicData.map(clinic => 
                            `<span class="inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full mr-1 mb-1">${clinic.name}</span>`
                          ).join('')
                        : '<span class="text-gray-500 text-xs">No clinic assigned</span>';
                    
                    // Multi-clinic badge
                    const multiClinicBadge = isMultiClinic
                        ? `<span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs px-3 py-1 rounded-full font-semibold">
                             <i class="fas fa-hospital mr-1"></i>${clinicData.length} Clinics
                           </span>`
                        : '';
                    
                    const card = `
                        <div onclick="viewDoctorDetails('${doctor.id}')" class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition cursor-pointer ${isMultiClinic ? 'border-2 border-purple-200' : ''}">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-blue-500 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-user-md text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800">${doctor.name}</h3>
                                        <p class="text-xs text-gray-600">${doctor.email}</p>
                                    </div>
                                </div>
                                ${multiClinicBadge}
                            </div>
                            
                            <div class="mb-3">
                                <p class="text-xs text-gray-600 mb-2"><i class="fas fa-stethoscope mr-1"></i>${doctor.specialty || 'General Dentist'}</p>
                            </div>
                            
                            <div class="mb-4">
                                <p class="text-xs text-gray-600 mb-2"><i class="fas fa-hospital mr-1"></i>Clinics:</p>
                                <div class="flex flex-wrap">
                                    ${clinicPills}
                                </div>
                            </div>
                            
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-phone w-5"></i>
                                    <span>${doctor.phone || 'N/A'}</span>
                                </div>
                            </div>
                            
                            <div class="text-center pt-3 border-t border-gray-200">
                                <span class="text-xs text-blue-600 font-semibold">
                                    <i class="fas fa-eye mr-1"></i>Click to view details
                                </span>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                }
                
            } catch (error) {
                console.error('Error loading doctors:', error);
                showToast('Error loading doctors', 'error');
            }
        }
        
        async function loadStaff() {
            try {
                const filterClinic = document.getElementById('filter-clinic-staff').value;
                let query = db.collection('users').where('role', '==', 'staff');
                
                if (filterClinic) {
                    query = query.where('clinicId', '==', filterClinic);
                }
                
                const snapshot = await query.get();
                const staff = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const container = document.getElementById('staff-grid');
                container.innerHTML = '';
                
                if (staff.length === 0) {
                    container.innerHTML = '<div class="col-span-full text-center py-12"><p class="text-gray-500">No staff found</p></div>';
                    return;
                }
                
                for (const member of staff) {
                    let clinicName = 'Not assigned';
                    if (member.clinicId) {
                        const clinicDoc = await db.collection('clinics').doc(member.clinicId).get();
                        if (clinicDoc.exists) {
                            clinicName = clinicDoc.data().name;
                        }
                    }
                    
                    const card = `
                        <div onclick="viewStaffDetails('${member.id}')" class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition cursor-pointer">
                            <div class="flex items-start justify-between mb-4">
                                <div class="flex items-center space-x-3">
                                    <div class="w-12 h-12 bg-green-500 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-user text-white text-xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-800">${member.name}</h3>
                                        <p class="text-xs text-gray-600">${member.email}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-2 mb-4">
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-hospital w-5"></i>
                                    <span>${clinicName}</span>
                                </div>
                                <div class="flex items-center text-sm text-gray-600">
                                    <i class="fas fa-phone w-5"></i>
                                    <span>${member.phone || 'N/A'}</span>
                                </div>
                            </div>
                            <div class="text-center pt-3 border-t border-gray-200">
                                <span class="text-xs text-green-600 font-semibold">
                                    <i class="fas fa-eye mr-1"></i>Click to view details
                                </span>
                            </div>
                        </div>
                    `;
                    container.innerHTML += card;
                }
                
            } catch (error) {
                console.error('Error loading staff:', error);
                showToast('Error loading staff', 'error');
            }
        }
        
        async function loadAppointments() {
            try {
                const snapshot = await db.collection('appointments').orderBy('createdAt', 'desc').limit(100).get();
                allAppointments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                filterAppointments();
                
            } catch (error) {
                console.error('Error loading appointments:', error);
                showToast('Error loading appointments', 'error');
            }
        }
        
        function filterAppointments() {
            const filterClinic = document.getElementById('filter-clinic-apt').value;
            const filterStatus = document.getElementById('filter-status').value;
            const filterDate = document.getElementById('filter-date').value;
            const filterSearch = document.getElementById('filter-search').value.toLowerCase();
            
            let filtered = allAppointments;
            
            if (filterClinic) {
                filtered = filtered.filter(apt => apt.clinicId === filterClinic);
            }
            
            if (filterStatus) {
                filtered = filtered.filter(apt => apt.status === filterStatus);
            }
            
            if (filterDate) {
                filtered = filtered.filter(apt => apt.date === filterDate);
            }
            
            if (filterSearch) {
                filtered = filtered.filter(apt => 
                    (apt.patientName || '').toLowerCase().includes(filterSearch)
                );
            }
            
            const container = document.getElementById('appointments-table-body');
            container.innerHTML = '';
            
            if (filtered.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="px-6 py-12 text-center text-gray-500">No appointments found</td></tr>';
                return;
            }
            
            filtered.forEach(apt => {
                const statusColors = {
                    'booked': 'bg-blue-100 text-blue-800',
                    'approve': 'bg-purple-100 text-purple-800',
                    'appointment': 'bg-green-100 text-green-800',
                    'missed': 'bg-orange-100 text-orange-800',
                    'cancelled': 'bg-red-100 text-red-800',
                    'completed': 'bg-gray-100 text-gray-800'
                };
                const statusColor = statusColors[apt.status] || 'bg-gray-100 text-gray-800';
                
                const row = `
                    <tr onclick="viewAppointmentDetails('${apt.id}')" class="hover:bg-gray-50 cursor-pointer transition">
                        <td class="px-6 py-4">
                            <div class="font-semibold text-gray-800">${apt.patientName || 'N/A'}</div>
                            <div class="text-xs text-gray-600">${apt.patientPhone || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-600">${apt.doctorName || 'N/A'}</td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-800">${apt.date || 'N/A'}</div>
                            <div class="text-xs text-gray-600">${apt.time || apt.startTime || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColor}">${apt.status || 'N/A'}</span>
                        </td>
                    </tr>
                `;
                container.innerHTML += row;
            });
        }
        
        function clearFilters() {
            document.getElementById('filter-clinic-apt').value = '';
            document.getElementById('filter-status').value = '';
            document.getElementById('filter-date').value = '';
            document.getElementById('filter-search').value = '';
            filterAppointments();
        }
        
        // ========== CLINIC ANALYTICS ==========
        
        async function loadClinicAnalytics() {
            try {
                const [clinicsSnap, appointmentsSnap, usersSnap] = await Promise.all([
                    db.collection('clinics').get(),
                    db.collection('appointments').get(),
                    db.collection('users').get()
                ]);
                
                const clinics = clinicsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const appointments = appointmentsSnap.docs.map(doc => doc.data());
                const users = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const container = document.getElementById('clinic-analytics-table');
                container.innerHTML = '';
                
                if (clinics.length === 0) {
                    container.innerHTML = '<tr><td colspan="8" class="px-6 py-12 text-center text-gray-500">No clinics yet</td></tr>';
                    return;
                }
                
                clinics.forEach(clinic => {
                    const clinicAppts = appointments.filter(a => a.clinicId === clinic.id);
                    const completed = clinicAppts.filter(a => a.status === 'completed').length;
                    const completionRate = clinicAppts.length > 0 ? ((completed / clinicAppts.length) * 100).toFixed(0) : 0;
                    
                    const uniquePatients = new Set(clinicAppts.map(a => a.patientPhone || a.patientEmail)).size;
                    const doctors = users.filter(u => u.role === 'doctor' && u.clinicIds?.includes(clinic.id)).length;
                    const staff = users.filter(u => u.role === 'staff' && u.clinicId === clinic.id).length;
                    
                    const statusIcon = clinic.active ? '' : '';
                    
                    const row = `
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4">
                                <div class="font-semibold text-gray-800">${clinic.name}</div>
                                <div class="text-xs text-gray-500">${clinic.city || 'N/A'}</div>
                            </td>
                            <td class="px-6 py-4 text-2xl">${statusIcon}</td>
                            <td class="px-6 py-4 font-semibold text-gray-800">${clinicAppts.length}</td>
                            <td class="px-6 py-4">
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${completionRate >= 80 ? 'bg-green-100 text-green-800' : completionRate >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}">
                                    ${completionRate}%
                                </span>
                            </td>
                            <td class="px-6 py-4 font-semibold text-gray-800">${uniquePatients}</td>
                            <td class="px-6 py-4 font-semibold text-gray-800">${doctors}</td>
                            <td class="px-6 py-4 font-semibold text-gray-800">${staff}</td>
                            <td class="px-6 py-4">
                                <button onclick="viewClinicDetail('${clinic.id}')" class="text-primary hover:text-blue-700 font-semibold">
                                    <i class="fas fa-chart-line mr-1"></i> View Details
                                </button>
                            </td>
                        </tr>
                    `;
                    container.innerHTML += row;
                });
                
            } catch (error) {
                console.error('Error loading clinic analytics:', error);
                showToast('Error loading clinic analytics', 'error');
            }
        }
        
        async function viewClinicDetail(clinicId) {
            try {
                const [clinicDoc, appointmentsSnap, usersSnap] = await Promise.all([
                    db.collection('clinics').doc(clinicId).get(),
                    db.collection('appointments').where('clinicId', '==', clinicId).get(),
                    db.collection('users').get()
                ]);
                
                const clinic = clinicDoc.data();
                const appointments = appointmentsSnap.docs.map(doc => doc.data());
                const users = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                document.getElementById('clinic-detail-name').textContent = clinic.name;
                
                // Stats
                const completed = appointments.filter(a => a.status === 'completed').length;
                const completionRate = appointments.length > 0 ? ((completed / appointments.length) * 100).toFixed(1) : 0;
                const uniquePatients = new Set(appointments.map(a => a.patientPhone || a.patientEmail)).size;
                const doctors = users.filter(u => u.role === 'doctor' && u.clinicIds?.includes(clinicId));
                const staff = users.filter(u => u.role === 'staff' && u.clinicId === clinicId);
                
                document.getElementById('clinic-total-appts').textContent = appointments.length;
                document.getElementById('clinic-appts-trend').textContent = 'All time';
                document.getElementById('clinic-completion').textContent = completionRate + '%';
                document.getElementById('clinic-patients').textContent = uniquePatients;
                document.getElementById('clinic-patients-trend').textContent = 'Unique patients';
                document.getElementById('clinic-team').textContent = doctors.length + staff.length;
                document.getElementById('clinic-team-breakdown').textContent = `${doctors.length} doctors, ${staff.length} staff`;
                
                // Status breakdown
                ['booked', 'approve', 'appointment', 'completed', 'cancelled', 'missed'].forEach(status => {
                    const count = appointments.filter(a => a.status === status).length;
                    document.getElementById(`clinic-status-${status}`).textContent = count;
                });
                
                // Top doctors
                const doctorStats = doctors.map(doc => {
                    const docAppts = appointments.filter(a => (a.userId === doc.id || a.doctorId === doc.id));
                    const docCompleted = docAppts.filter(a => a.status === 'completed').length;
                    return {
                        name: doc.name,
                        appointments: docAppts.length,
                        completion: docAppts.length > 0 ? ((docCompleted / docAppts.length) * 100).toFixed(0) : 0
                    };
                }).sort((a, b) => b.appointments - a.appointments).slice(0, 5);
                
                const topDoctorsHtml = doctorStats.map(doc => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div>
                            <p class="font-semibold text-gray-800">${doc.name}</p>
                            <p class="text-xs text-gray-600">${doc.appointments} appointments</p>
                        </div>
                        <span class="text-sm font-semibold text-green-600">${doc.completion}%</span>
                    </div>
                `).join('');
                document.getElementById('clinic-top-doctors').innerHTML = topDoctorsHtml || '<p class="text-gray-500 text-sm">No data</p>';
                
                // Top services
                const serviceCount = {};
                appointments.forEach(apt => {
                    const service = apt.service || apt.patientService || 'Unknown';
                    serviceCount[service] = (serviceCount[service] || 0) + 1;
                });
                const topServices = Object.entries(serviceCount).sort((a, b) => b[1] - a[1]).slice(0, 5);
                
                const topServicesHtml = topServices.map(([service, count]) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <p class="font-semibold text-gray-800">${service}</p>
                        <span class="text-sm font-semibold text-primary">${count} bookings</span>
                    </div>
                `).join('');
                document.getElementById('clinic-top-services').innerHTML = topServicesHtml || '<p class="text-gray-500 text-sm">No data</p>';
                
                // Show detail view
                document.querySelector('#section-clinic-analytics > div:first-child').classList.add('hidden');
                document.getElementById('clinic-detail-view').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading clinic detail:', error);
                showToast('Error loading clinic detail', 'error');
            }
        }
        
        function closeClinicDetail() {
            document.querySelector('#section-clinic-analytics > div:first-child').classList.remove('hidden');
            document.getElementById('clinic-detail-view').classList.add('hidden');
        }
        
        // ========== PATIENT ANALYTICS ==========
        
        let allPatientData = [];
        
        async function loadPatientAnalytics() {
            try {
                const [appointmentsSnap, clinicsSnap] = await Promise.all([
                    db.collection('appointments').get(),
                    db.collection('clinics').get()
                ]);
                
                const appointments = appointmentsSnap.docs.map(doc => doc.data());
                const clinics = clinicsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Populate clinic filter
                const clinicFilter = document.getElementById('patient-clinic-filter');
                clinicFilter.innerHTML = '<option value="">All Clinics</option>';
                clinics.forEach(clinic => {
                    clinicFilter.innerHTML += `<option value="${clinic.id}">${clinic.name}</option>`;
                });
                
                // Group appointments by patient
                const patientsMap = new Map();
                appointments.forEach(apt => {
                    const key = apt.patientPhone || apt.patientEmail || apt.patientName;
                    if (!patientsMap.has(key)) {
                        patientsMap.set(key, {
                            name: apt.patientName,
                            phone: apt.patientPhone || apt.phone,
                            email: apt.patientEmail || apt.email,
                            visits: [],
                            clinics: new Set()
                        });
                    }
                    const patient = patientsMap.get(key);
                    patient.visits.push(apt);
                    if (apt.clinicId) patient.clinics.add(apt.clinicId);
                });
                
                allPatientData = Array.from(patientsMap.values()).map(patient => {
                    const sortedVisits = patient.visits.sort((a, b) => (b.date || '').localeCompare(a.date || ''));
                    const lastVisit = sortedVisits[0]?.date || 'N/A';
                    const daysSinceLastVisit = lastVisit !== 'N/A' ? Math.floor((new Date() - new Date(lastVisit)) / (1000 * 60 * 60 * 24)) : 999;
                    
                    const completed = patient.visits.filter(v => v.status === 'completed').length;
                    const reliability = patient.visits.length > 0 ? ((completed / patient.visits.length) * 100).toFixed(0) : 0;
                    
                    let status = 'Active';
                    if (daysSinceLastVisit > 90) status = 'Inactive';
                    else if (patient.visits.length === 1) status = 'New';
                    
                    return {
                        ...patient,
                        lastVisit,
                        daysSinceLastVisit,
                        reliability,
                        status,
                        sortedVisits
                    };
                });
                
                displayPatientAnalytics(allPatientData);
                
            } catch (error) {
                console.error('Error loading patient analytics:', error);
                showToast('Error loading patient analytics', 'error');
            }
        }
        
        function displayPatientAnalytics(patients) {
            const container = document.getElementById('patient-analytics-table');
            container.innerHTML = '';
            
            if (patients.length === 0) {
                container.innerHTML = '<tr><td colspan="7" class="px-6 py-12 text-center text-gray-500">No patients found</td></tr>';
                return;
            }
            
            patients.forEach(patient => {
                const statusColors = {
                    'Active': 'bg-green-100 text-green-800',
                    'Inactive': 'bg-red-100 text-red-800',
                    'New': 'bg-blue-100 text-blue-800'
                };
                
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4">
                            <div class="font-semibold text-gray-800">${patient.name || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600">${patient.phone || 'N/A'}</div>
                            <div class="text-xs text-gray-500">${patient.email || 'N/A'}</div>
                        </td>
                        <td class="px-6 py-4 font-semibold text-gray-800">${patient.visits.length}</td>
                        <td class="px-6 py-4 text-sm text-gray-600">${patient.lastVisit}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColors[patient.status]}">
                                ${patient.status}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-sm font-semibold ${patient.reliability >= 80 ? 'text-green-600' : patient.reliability >= 60 ? 'text-yellow-600' : 'text-red-600'}">
                                ${patient.reliability}%
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick='viewPatientDetail(${JSON.stringify(patient).replace(/'/g, "&apos;")})' class="text-primary hover:text-blue-700 font-semibold">
                                <i class="fas fa-user mr-1"></i> View Profile
                            </button>
                        </td>
                    </tr>
                `;
                container.innerHTML += row;
            });
        }
        
        function searchPatientAnalytics() {
            const search = document.getElementById('patient-search').value.toLowerCase();
            const filtered = allPatientData.filter(p => 
                (p.name || '').toLowerCase().includes(search) ||
                (p.phone || '').toLowerCase().includes(search) ||
                (p.email || '').toLowerCase().includes(search)
            );
            displayPatientAnalytics(filtered);
        }
        
        function filterPatientAnalytics() {
            const clinicFilter = document.getElementById('patient-clinic-filter').value;
            const statusFilter = document.getElementById('patient-status-filter').value;
            
            let filtered = allPatientData;
            
            if (clinicFilter) {
                filtered = filtered.filter(p => p.clinics.has(clinicFilter));
            }
            
            if (statusFilter === 'active') {
                filtered = filtered.filter(p => p.status === 'Active');
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(p => p.status === 'Inactive');
            } else if (statusFilter === 'new') {
                filtered = filtered.filter(p => p.status === 'New');
            }
            
            displayPatientAnalytics(filtered);
        }
        
        async function viewPatientDetail(patient) {
            try {
                const clinicsSnap = await db.collection('clinics').get();
                const clinics = clinicsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                document.getElementById('patient-detail-name').textContent = patient.name || 'N/A';
                document.getElementById('patient-detail-contact').textContent = `${patient.phone || 'N/A'}  ${patient.email || 'N/A'}`;
                
                const statusColors = {
                    'Active': 'bg-green-100 text-green-800',
                    'Inactive': 'bg-red-100 text-red-800',
                    'New': 'bg-blue-100 text-blue-800'
                };
                const badge = document.getElementById('patient-detail-status-badge');
                badge.textContent = patient.status;
                badge.className = `px-3 py-1 rounded-full text-sm font-semibold ${statusColors[patient.status]}`;
                
                document.getElementById('patient-total-visits').textContent = patient.visits.length;
                document.getElementById('patient-reliability').textContent = patient.reliability + '%';
                
                // Calculate visit frequency
                if (patient.visits.length > 1) {
                    const dates = patient.visits.map(v => new Date(v.date)).sort((a, b) => a - b);
                    let totalDays = 0;
                    for (let i = 1; i < dates.length; i++) {
                        totalDays += (dates[i] - dates[i-1]) / (1000 * 60 * 60 * 24);
                    }
                    const avgFrequency = Math.round(totalDays / (dates.length - 1));
                    document.getElementById('patient-frequency').textContent = avgFrequency;
                } else {
                    document.getElementById('patient-frequency').textContent = '-';
                }
                
                document.getElementById('patient-last-visit').textContent = patient.lastVisit;
                
                // Visit history
                const historyHtml = patient.sortedVisits.map(visit => {
                    const clinic = clinics.find(c => c.id === visit.clinicId);
                    const statusColors = {
                        'completed': 'bg-green-100 text-green-800',
                        'cancelled': 'bg-red-100 text-red-800',
                        'missed': 'bg-orange-100 text-orange-800',
                        'booked': 'bg-blue-100 text-blue-800'
                    };
                    return `
                        <tr>
                            <td class="px-4 py-2 text-sm">${visit.date || 'N/A'}</td>
                            <td class="px-4 py-2 text-sm">${visit.service || visit.patientService || 'N/A'}</td>
                            <td class="px-4 py-2 text-sm">${visit.doctorName || 'N/A'}</td>
                            <td class="px-4 py-2 text-sm">${clinic?.name || 'N/A'}</td>
                            <td class="px-4 py-2">
                                <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColors[visit.status] || 'bg-gray-100 text-gray-800'}">
                                    ${visit.status || 'N/A'}
                                </span>
                            </td>
                        </tr>
                    `;
                }).join('');
                document.getElementById('patient-visit-history').innerHTML = historyHtml;
                
                // Preferences
                const doctorCount = {};
                const clinicCount = {};
                const serviceCount = {};
                
                patient.visits.forEach(visit => {
                    doctorCount[visit.doctorName] = (doctorCount[visit.doctorName] || 0) + 1;
                    if (visit.clinicId) clinicCount[visit.clinicId] = (clinicCount[visit.clinicId] || 0) + 1;
                    const service = visit.service || visit.patientService;
                    if (service) serviceCount[service] = (serviceCount[service] || 0) + 1;
                });
                
                const preferredDoctor = Object.entries(doctorCount).sort((a, b) => b[1] - a[1])[0];
                const preferredClinicId = Object.entries(clinicCount).sort((a, b) => b[1] - a[1])[0];
                const preferredService = Object.entries(serviceCount).sort((a, b) => b[1] - a[1])[0];
                
                document.getElementById('patient-preferred-doctor').textContent = preferredDoctor ? `${preferredDoctor[0]} (${preferredDoctor[1]} visits)` : 'N/A';
                document.getElementById('patient-preferred-clinic').textContent = preferredClinicId ? `${clinics.find(c => c.id === preferredClinicId[0])?.name} (${preferredClinicId[1]} visits)` : 'N/A';
                document.getElementById('patient-preferred-service').textContent = preferredService ? `${preferredService[0]} (${preferredService[1]} times)` : 'N/A';
                
                // Show detail view
                document.querySelector('#section-patient-analytics > div:nth-child(2)').classList.add('hidden');
                document.querySelector('#section-patient-analytics > div:nth-child(3)').classList.add('hidden');
                document.getElementById('patient-detail-view').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading patient detail:', error);
                showToast('Error loading patient detail', 'error');
            }
        }
        
        function closePatientDetail() {
            document.querySelector('#section-patient-analytics > div:nth-child(2)').classList.remove('hidden');
            document.querySelector('#section-patient-analytics > div:nth-child(3)').classList.remove('hidden');
            document.getElementById('patient-detail-view').classList.add('hidden');
        }
        
        // ========== SYSTEM ANALYTICS ==========
        
        async function loadAnalytics() {
            try {
                const [clinicsSnap, usersSnap, appointmentsSnap] = await Promise.all([
                    db.collection('clinics').get(),
                    db.collection('users').get(),
                    db.collection('appointments').get()
                ]);
                
                const clinics = clinicsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const users = usersSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const appointments = appointmentsSnap.docs.map(doc => doc.data());
                
                // System Overview
                const activeClinics = clinics.filter(c => c.active).length;
                const inactiveClinics = clinics.length - activeClinics;
                document.getElementById('sys-total-clinics').textContent = clinics.length;
                document.getElementById('sys-clinics-badge').textContent = `${activeClinics} active`;
                document.getElementById('sys-clinics-status').textContent = `${activeClinics} active, ${inactiveClinics} inactive`;
                
                const doctors = users.filter(u => u.role === 'doctor');
                const activeDoctors = doctors.filter(d => d.active !== false).length;
                document.getElementById('sys-total-doctors').textContent = doctors.length;
                document.getElementById('sys-doctors-badge').textContent = `${activeDoctors} active`;
                document.getElementById('sys-doctors-status').textContent = `${activeDoctors} active, ${doctors.length - activeDoctors} inactive`;
                
                const staff = users.filter(u => u.role === 'staff');
                const activeStaff = staff.filter(s => s.active !== false).length;
                document.getElementById('sys-total-staff').textContent = staff.length;
                document.getElementById('sys-staff-badge').textContent = `${activeStaff} active`;
                document.getElementById('sys-staff-status').textContent = `${activeStaff} active, ${staff.length - activeStaff} inactive`;
                
                const uniquePatients = new Set(appointments.map(a => a.patientPhone || a.patientEmail)).size;
                document.getElementById('sys-total-patients').textContent = uniquePatients;
                document.getElementById('sys-patients-badge').textContent = 'Unique';
                
                document.getElementById('sys-total-appointments').textContent = appointments.length;
                document.getElementById('sys-appts-badge').textContent = 'All time';
                
                // Performance Metrics
                const total = appointments.length;
                const completed = appointments.filter(a => a.status === 'completed').length;
                const cancelled = appointments.filter(a => a.status === 'cancelled').length;
                const missed = appointments.filter(a => a.status === 'missed').length;
                
                const completionRate = total > 0 ? ((completed / total) * 100).toFixed(1) : 0;
                const cancellationRate = total > 0 ? ((cancelled / total) * 100).toFixed(1) : 0;
                const noshowRate = total > 0 ? ((missed / total) * 100).toFixed(1) : 0;
                
                document.getElementById('completion-rate').textContent = completionRate + '%';
                document.getElementById('cancellation-rate').textContent = cancellationRate + '%';
                document.getElementById('noshow-rate').textContent = noshowRate + '%';
                
                // Animate circles
                const circumference = 2 * Math.PI * 40;
                const completionOffset = circumference - (completionRate / 100) * circumference;
                const cancellationOffset = circumference - (cancellationRate / 100) * circumference;
                const noshowOffset = circumference - (noshowRate / 100) * circumference;
                
                document.getElementById('completion-circle').style.strokeDashoffset = completionOffset;
                document.getElementById('cancellation-circle').style.strokeDashoffset = cancellationOffset;
                document.getElementById('noshow-circle').style.strokeDashoffset = noshowOffset;
                
                const daysWithAppointments = new Set(appointments.map(a => a.date)).size;
                const avgDaily = daysWithAppointments > 0 ? (total / daysWithAppointments).toFixed(1) : 0;
                document.getElementById('avg-daily').textContent = avgDaily;
                
                // Growth Metrics
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();
                const lastMonth = currentMonth === 0 ? 11 : currentMonth - 1;
                const lastMonthYear = currentMonth === 0 ? currentYear - 1 : currentYear;
                
                const thisMonthAppts = appointments.filter(a => {
                    if (!a.date) return false;
                    const d = new Date(a.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                });
                
                const lastMonthAppts = appointments.filter(a => {
                    if (!a.date) return false;
                    const d = new Date(a.date);
                    return d.getMonth() === lastMonth && d.getFullYear() === lastMonthYear;
                });
                
                document.getElementById('sys-month-appointments').textContent = thisMonthAppts.length;
                
                const apptsGrowth = lastMonthAppts.length > 0 
                    ? (((thisMonthAppts.length - lastMonthAppts.length) / lastMonthAppts.length) * 100).toFixed(1)
                    : 0;
                const apptsGrowthHtml = apptsGrowth >= 0 
                    ? `<span class="text-green-600"><i class="fas fa-arrow-up mr-1"></i>${apptsGrowth}% from last month</span>`
                    : `<span class="text-red-600"><i class="fas fa-arrow-down mr-1"></i>${Math.abs(apptsGrowth)}% from last month</span>`;
                document.getElementById('sys-appts-growth').innerHTML = apptsGrowthHtml;
                
                // New patients this month
                const patientsMap = new Map();
                appointments.forEach(apt => {
                    const key = apt.patientPhone || apt.patientEmail;
                    if (!patientsMap.has(key)) {
                        patientsMap.set(key, apt.date);
                    } else {
                        const existingDate = patientsMap.get(key);
                        if (apt.date < existingDate) {
                            patientsMap.set(key, apt.date);
                        }
                    }
                });
                
                let newPatientsThisMonth = 0;
                let newPatientsLastMonth = 0;
                patientsMap.forEach(firstVisitDate => {
                    const d = new Date(firstVisitDate);
                    if (d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                        newPatientsThisMonth++;
                    }
                    if (d.getMonth() === lastMonth && d.getFullYear() === lastMonthYear) {
                        newPatientsLastMonth++;
                    }
                });
                
                document.getElementById('sys-new-patients').textContent = newPatientsThisMonth;
                
                const patientsGrowth = newPatientsLastMonth > 0 
                    ? (((newPatientsThisMonth - newPatientsLastMonth) / newPatientsLastMonth) * 100).toFixed(1)
                    : 0;
                const patientsGrowthHtml = patientsGrowth >= 0 
                    ? `<span class="text-green-600"><i class="fas fa-arrow-up mr-1"></i>${patientsGrowth}% from last month</span>`
                    : `<span class="text-red-600"><i class="fas fa-arrow-down mr-1"></i>${Math.abs(patientsGrowth)}% from last month</span>`;
                document.getElementById('sys-patients-growth').innerHTML = patientsGrowthHtml;
                
                // Overall growth (average of appointments and patients)
                const overallGrowth = ((parseFloat(apptsGrowth) + parseFloat(patientsGrowth)) / 2).toFixed(1);
                document.getElementById('sys-overall-growth').textContent = overallGrowth + '%';
                const overallGrowthHtml = overallGrowth >= 0 
                    ? `<span class="text-green-600"><i class="fas fa-arrow-up mr-1"></i>Growing</span>`
                    : `<span class="text-red-600"><i class="fas fa-arrow-down mr-1"></i>Declining</span>`;
                document.getElementById('sys-growth-trend').innerHTML = overallGrowthHtml;
                
                // Top Performers
                const clinicApptCount = {};
                appointments.forEach(apt => {
                    if (apt.clinicId) {
                        clinicApptCount[apt.clinicId] = (clinicApptCount[apt.clinicId] || 0) + 1;
                    }
                });
                const topClinicId = Object.entries(clinicApptCount).sort((a, b) => b[1] - a[1])[0];
                if (topClinicId) {
                    const topClinic = clinics.find(c => c.id === topClinicId[0]);
                    document.getElementById('sys-top-clinic').innerHTML = `
                        <p class="text-lg font-bold text-gray-800">${topClinic?.name || 'N/A'}</p>
                        <p class="text-sm text-gray-600">${topClinicId[1]} appointments</p>
                        <p class="text-xs text-green-600 font-semibold mt-1">
                            <i class="fas fa-trophy mr-1"></i>Best performing clinic
                        </p>
                    `;
                } else {
                    document.getElementById('sys-top-clinic').innerHTML = '<p class="text-gray-500">No data yet</p>';
                }
                
                const doctorApptCount = {};
                appointments.forEach(apt => {
                    if (apt.doctorName) {
                        doctorApptCount[apt.doctorName] = (doctorApptCount[apt.doctorName] || 0) + 1;
                    }
                });
                const topDoctor = Object.entries(doctorApptCount).sort((a, b) => b[1] - a[1])[0];
                if (topDoctor) {
                    document.getElementById('sys-top-doctor').innerHTML = `
                        <p class="text-lg font-bold text-gray-800">${topDoctor[0]}</p>
                        <p class="text-sm text-gray-600">${topDoctor[1]} appointments</p>
                        <p class="text-xs text-green-600 font-semibold mt-1">
                            <i class="fas fa-star mr-1"></i>Most appointments
                        </p>
                    `;
                } else {
                    document.getElementById('sys-top-doctor').innerHTML = '<p class="text-gray-500">No data yet</p>';
                }
                
                const serviceCount = {};
                appointments.forEach(apt => {
                    const service = apt.service || apt.patientService;
                    if (service) {
                        serviceCount[service] = (serviceCount[service] || 0) + 1;
                    }
                });
                const topService = Object.entries(serviceCount).sort((a, b) => b[1] - a[1])[0];
                if (topService) {
                    document.getElementById('sys-top-service').innerHTML = `
                        <p class="text-lg font-bold text-gray-800">${topService[0]}</p>
                        <p class="text-sm text-gray-600">${topService[1]} bookings</p>
                        <p class="text-xs text-green-600 font-semibold mt-1">
                            <i class="fas fa-fire mr-1"></i>Most popular service
                        </p>
                    `;
                } else {
                    document.getElementById('sys-top-service').innerHTML = '<p class="text-gray-500">No data yet</p>';
                }
                
                // Status Distribution
                const statuses = ['booked', 'approve', 'appointment', 'completed', 'cancelled', 'missed'];
                statuses.forEach(status => {
                    const count = appointments.filter(a => a.status === status).length;
                    const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                    document.getElementById(`sys-status-${status}`).textContent = count;
                    document.getElementById(`sys-status-${status}-pct`).textContent = `${percentage}%`;
                });
                
            } catch (error) {
                console.error('Error loading analytics:', error);
                showToast('Error loading analytics', 'error');
            }
        }
        
        // ========== ADMIN MANAGEMENT ==========
        
        async function loadAdmins() {
            try {
                console.log('Loading admins...');
                
                // Load clinics first
                const clinicsSnap = await db.collection('clinics').get();
                allClinics = clinicsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Loaded clinics:', allClinics.length);
                
                // Load all admin users
                const adminsSnap = await db.collection('users')
                    .where('role', '==', 'admin')
                    .get();
                
                const admins = adminsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log('Found admins:', admins.length, admins);
                
                displayAdmins(admins);
            } catch (error) {
                console.error('Error loading admins:', error);
                showToast('Error loading admins', 'error');
            }
        }
        
        function displayAdmins(admins) {
            const tbody = document.getElementById('admins-table-body');
            
            if (admins.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                            <i class="fas fa-user-shield text-4xl mb-2 text-gray-300"></i>
                            <p>No clinic admins yet. Create your first admin account!</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = admins.map(admin => {
                const clinic = allClinics.find(c => c.id === admin.clinicId);
                const clinicName = clinic ? clinic.name : 'Unknown Clinic';
                const statusBadge = admin.active 
                    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Active</span>'
                    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inactive</span>';
                
                const createdDate = admin.createdAt ? new Date(admin.createdAt.toDate()).toLocaleDateString() : 'N/A';
                
                return `
                    <tr class="hover:bg-gray-50 cursor-pointer transition" onclick="viewAdminDetails('${admin.id}')">
                        <td class="px-6 py-4">
                            <div class="flex items-center">
                                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold mr-3">
                                    ${admin.name ? admin.name.charAt(0).toUpperCase() : 'A'}
                                </div>
                                <div class="font-semibold text-gray-900">${admin.name || 'N/A'}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">${admin.email}</td>
                        <td class="px-6 py-4">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${clinicName}
                            </span>
                        </td>
                        <td class="px-6 py-4">${statusBadge}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${createdDate}</td>
                        <td class="px-6 py-4">
                            <button onclick="event.stopPropagation(); viewAdminDetails('${admin.id}')" 
                                    class="text-blue-600 hover:text-blue-800 mr-3" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="event.stopPropagation(); toggleAdminStatus('${admin.id}', ${!admin.active})" 
                                    class="text-${admin.active ? 'red' : 'green'}-600 hover:text-${admin.active ? 'red' : 'green'}-800" 
                                    title="${admin.active ? 'Deactivate' : 'Activate'}">
                                <i class="fas fa-${admin.active ? 'ban' : 'check-circle'}"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        async function showAddAdminModal() {
            // Load clinics for dropdown
            const clinicsSnap = await db.collection('clinics').where('active', '==', true).get();
            const clinics = clinicsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            if (clinics.length === 0) {
                showToast('Please create a clinic first before adding admins', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-user-shield text-primary mr-2"></i>Create Admin Account
                        </h3>
                        <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <form id="add-admin-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Select Clinic *</label>
                            <select id="admin-clinic" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                <option value="">Choose a clinic...</option>
                                ${clinics.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Admin Name *</label>
                            <input type="text" id="admin-name" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                   placeholder="e.g., John Doe">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address *</label>
                            <input type="email" id="admin-email" required 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                   placeholder="admin@clinic.com">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Password *</label>
                            <input type="password" id="admin-password" required minlength="6"
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary"
                                   placeholder="Min 6 characters">
                            <p class="text-xs text-gray-500 mt-1">Minimum 6 characters</p>
                        </div>
                        
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-3 rounded">
                            <p class="text-sm text-blue-700">
                                <i class="fas fa-info-circle mr-1"></i>
                                This admin will be able to manage only the selected clinic.
                            </p>
                        </div>
                        
                        <div class="flex space-x-3 pt-4">
                            <button type="button" onclick="closeModal()" id="admin-cancel-btn"
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" id="admin-submit-btn"
                                    class="flex-1 bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Create Admin
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.getElementById('modal-container').appendChild(modal);
            
            // Handle form submission
            document.getElementById('add-admin-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createAdmin();
            });
        }
        
        async function createAdmin() {
            const clinicId = document.getElementById('admin-clinic').value;
            const name = document.getElementById('admin-name').value.trim();
            const email = document.getElementById('admin-email').value.trim().toLowerCase();
            const password = document.getElementById('admin-password').value;
            
            if (!clinicId || !name || !email || !password) {
                showToast('Please fill all fields', 'error');
                return;
            }
            
            if (password.length < 6) {
                showToast('Password must be at least 6 characters', 'error');
                return;
            }
            
            // Show loading spinner on button
            const submitBtn = document.getElementById('admin-submit-btn');
            const cancelBtn = document.getElementById('admin-cancel-btn');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Creating...';
            submitBtn.disabled = true;
            cancelBtn.disabled = true;
            
            showLoading('Creating admin account...');
            
            try {
                // Check if email already exists in database
                const existingUser = await db.collection('users')
                    .where('email', '==', email)
                    .get();
                
                if (!existingUser.empty) {
                    hideLoading();
                    submitBtn.innerHTML = originalBtnText;
                    submitBtn.disabled = false;
                    cancelBtn.disabled = false;
                    showToast('This email is already in use', 'error');
                    return;
                }
                
                // Get current superadmin for audit trail
                const superAdminUser = auth.currentUser;
                
                // Create admin document directly in Firestore (NO Firebase Auth)
                const adminRef = await db.collection('users').add({
                    email: email,
                    password: password, // Store password in database
                    name: name,
                    role: 'admin',
                    clinicId: clinicId,
                    active: true,
                    permissions: ['manage_doctors', 'manage_staff', 'view_appointments', 'manage_patients'],
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: superAdminUser ? superAdminUser.uid : 'system'
                });
                
                console.log('Admin created with ID:', adminRef.id);
                
                // Update clinic with admin reference
                await db.collection('clinics').doc(clinicId).update({
                    adminId: adminRef.id,
                    adminEmail: email,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                hideLoading();
                showToast(` Admin account created for ${name}!`, 'success');
                closeModal();
                
                // Refresh the admin list AND clinics list to show connected status
                loadAdmins();
                loadClinics();
                
            } catch (error) {
                hideLoading();
                // Restore button state on error
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Create Admin';
                    submitBtn.disabled = false;
                }
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                }
                console.error('Error creating admin:', error);
                showToast('Error creating admin account: ' + error.message, 'error');
            }
        }
        
        function toggleAdminStatus(adminId, newStatus) {
            showConfirmModal(
                newStatus ? 'Activate Admin' : 'Deactivate Admin',
                `Are you sure you want to ${newStatus ? 'activate' : 'deactivate'} this admin?`,
                async () => {
                    try {
                        await db.collection('users').doc(adminId).update({
                            active: newStatus,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        showToast(`Admin ${newStatus ? 'activated' : 'deactivated'} successfully`, 'success');
                        loadAdmins();
                    } catch (error) {
                        console.error('Error updating admin status:', error);
                        showToast('Error updating admin status', 'error');
                    }
                },
                newStatus ? 'Activate' : 'Deactivate',
                newStatus ? 'green' : 'red'
            );
        }
        
        async function viewAdminDetails(adminId) {
            try {
                const adminDoc = await db.collection('users').doc(adminId).get();
                if (!adminDoc.exists) {
                    showToast('Admin not found', 'error');
                    return;
                }
                
                const admin = { id: adminDoc.id, ...adminDoc.data() };
                const clinic = allClinics.find(c => c.id === admin.clinicId);
                const clinicName = clinic ? clinic.name : 'Unknown Clinic';
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full p-6 max-h-screen overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center text-purple-600 font-bold text-2xl">
                                    ${admin.name ? admin.name.charAt(0).toUpperCase() : 'A'}
                                </div>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-800">${admin.name || 'Admin'}</h2>
                                    <p class="text-sm text-gray-600">Clinic Administrator</p>
                                </div>
                            </div>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Status Badge -->
                        <div class="mb-6">
                            ${admin.active 
                                ? '<span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>Active</span>'
                                : '<span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-ban mr-1"></i>Inactive</span>'}
                        </div>
                        
                        <!-- Admin Details -->
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-user mr-2 text-primary"></i>Full Name
                                </label>
                                <input type="text" id="edit-admin-name" value="${admin.name || ''}" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-envelope mr-2 text-primary"></i>Email Address
                                </label>
                                <input type="email" id="edit-admin-email" value="${admin.email || ''}" 
                                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-hospital mr-2 text-primary"></i>Assigned Clinic
                                </label>
                                <select id="edit-admin-clinic" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
                                    ${allClinics.map(c => `<option value="${c.id}" ${c.id === admin.clinicId ? 'selected' : ''}>${c.name}</option>`).join('')}
                                </select>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <label class="block text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-calendar mr-2 text-primary"></i>Created Date
                                </label>
                                <p class="text-gray-800">${admin.createdAt ? new Date(admin.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                            </div>
                        </div>
                        
                        <!-- Permissions -->
                        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-6">
                            <h3 class="font-bold text-gray-800 mb-2">
                                <i class="fas fa-shield-alt text-blue-600 mr-2"></i>Permissions
                            </h3>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                ${(admin.permissions || []).map(perm => `
                                    <div class="flex items-center text-gray-700">
                                        <i class="fas fa-check text-green-600 mr-2"></i>
                                        <span>${perm.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <button onclick="resetAdminPassword('${admin.id}')" 
                                    class="bg-yellow-500 text-white px-6 py-3 rounded-lg hover:bg-yellow-600 transition font-semibold">
                                <i class="fas fa-key mr-2"></i>Reset Password
                            </button>
                            
                            <button onclick="toggleAdminStatus('${admin.id}', ${!admin.active}); closeModal();" 
                                    class="bg-${admin.active ? 'red' : 'green'}-500 text-white px-6 py-3 rounded-lg hover:bg-${admin.active ? 'red' : 'green'}-600 transition font-semibold">
                                <i class="fas fa-${admin.active ? 'ban' : 'check-circle'} mr-2"></i>${admin.active ? 'Deactivate' : 'Activate'} Admin
                            </button>
                        </div>
                        
                        <!-- Save and Delete Buttons -->
                        <div class="flex justify-between">
                            <button onclick="deleteAdmin('${admin.id}')" 
                                    class="bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition font-semibold">
                                <i class="fas fa-trash mr-2"></i>Delete Admin
                            </button>
                            
                            <div class="flex space-x-3">
                                <button onclick="closeModal()" 
                                        class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition font-semibold">
                                    Cancel
                                </button>
                                <button onclick="saveAdminChanges('${admin.id}')" 
                                        class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                                    <i class="fas fa-save mr-2"></i>Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('modal-container').appendChild(modal);
            } catch (error) {
                console.error('Error viewing admin details:', error);
                showToast('Error loading admin details', 'error');
            }
        }
        
        async function saveAdminChanges(adminId) {
            try {
                const name = document.getElementById('edit-admin-name').value.trim();
                const email = document.getElementById('edit-admin-email').value.trim();
                const clinicId = document.getElementById('edit-admin-clinic').value;
                
                if (!name || !email || !clinicId) {
                    showToast('Please fill all required fields', 'warning');
                    return;
                }
                
                showLoading('Saving changes...');
                
                await db.collection('users').doc(adminId).update({
                    name: name,
                    email: email,
                    clinicId: clinicId,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                hideLoading();
                showToast('Admin details updated successfully!', 'success');
                closeModal();
                loadAdmins();
            } catch (error) {
                hideLoading();
                console.error('Error saving admin changes:', error);
                showToast('Error saving changes', 'error');
            }
        }
        
        function resetAdminPassword(adminId) {
            showInputModal('Reset Password', 'Enter new password (min 6 characters)', 'Reset Password', async (newPassword) => {
                if (newPassword.length < 6) {
                    showToast('Password must be at least 6 characters', 'warning');
                    return;
                }
                
                try {
                    showLoading('Resetting password...');
                    
                    await db.collection('users').doc(adminId).update({
                        password: newPassword,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    hideLoading();
                    showToast('Password reset successfully!', 'success');
                    showInfoModal('Password Reset', `Password has been reset to: <strong>${newPassword}</strong><br><br>Please share this with the admin securely.`);
                } catch (error) {
                    hideLoading();
                    console.error('Error resetting password:', error);
                    showToast('Error resetting password', 'error');
                }
            });
        }
        
        function deleteAdmin(adminId) {
            showConfirmModal(' Delete Admin', 'This will permanently delete this admin account. This action cannot be undone.', async () => {
                try {
                    showLoading('Deleting admin...');
                    
                    await db.collection('users').doc(adminId).delete();
                    
                    hideLoading();
                    showToast('Admin deleted successfully', 'success');
                    closeModal();
                    loadAdmins();
                } catch (error) {
                    hideLoading();
                    console.error('Error deleting admin:', error);
                    showToast('Error deleting admin', 'error');
                }
            }, 'Delete', 'red');
        }
        
        // ========== MODAL FUNCTIONS ==========
        
        async function viewDoctorDetails(doctorId) {
            try {
                const doctorDoc = await db.collection('users').doc(doctorId).get();
                if (!doctorDoc.exists) {
                    showToast('Doctor not found', 'error');
                    return;
                }
                
                const doctor = { id: doctorDoc.id, ...doctorDoc.data() };
                
                // Get full clinic data
                let clinicData = [];
                let primaryClinicId = null;
                
                if (doctor.clinicIds && doctor.clinicIds.length > 0) {
                    // Multi-clinic doctor
                    const clinicPromises = doctor.clinicIds.map(id => db.collection('clinics').doc(id).get());
                    const clinicDocs = await Promise.all(clinicPromises);
                    clinicData = clinicDocs
                        .filter(d => d.exists)
                        .map(d => ({ id: d.id, ...d.data() }));
                    primaryClinicId = doctor.clinicId || clinicData[0]?.id; // First clinic is primary if no clinicId
                } else if (doctor.clinicId) {
                    // Single clinic doctor
                    const clinicDoc = await db.collection('clinics').doc(doctor.clinicId).get();
                    if (clinicDoc.exists) {
                        clinicData = [{ id: clinicDoc.id, ...clinicDoc.data() }];
                        primaryClinicId = clinicDoc.id;
                    }
                }
                
                // Get appointment stats
                const appointmentsSnap = await db.collection('appointments')
                    .where('userId', '==', doctorId)
                    .get();
                const appointments = appointmentsSnap.docs.map(doc => doc.data());
                const totalAppointments = appointments.length;
                const completedAppointments = appointments.filter(a => a.status === 'completed').length;
                const upcomingAppointments = appointments.filter(a => a.status === 'booked' || a.status === 'appointment').length;
                
                // Get services count
                const servicesSnap = await db.collection('services')
                    .where('userId', '==', doctorId)
                    .get();
                const servicesCount = servicesSnap.size;
                
                // Create clinic cards HTML
                let clinicCardsHTML = '';
                if (clinicData.length > 0) {
                    for (const clinic of clinicData) {
                        const isPrimary = clinic.id === primaryClinicId;
                        
                        // Get appointments for this clinic
                        const clinicAppointments = appointments.filter(a => a.clinicId === clinic.id);
                        const clinicApptCount = clinicAppointments.length;
                        const clinicCompletedCount = clinicAppointments.filter(a => a.status === 'completed').length;
                        
                        // Get services for this clinic
                        const clinicServices = await db.collection('services')
                            .where('userId', '==', doctorId)
                            .where('clinicId', '==', clinic.id)
                            .get();
                        const clinicServicesCount = clinicServices.size;
                        
                        clinicCardsHTML += `
                            <div class="bg-gradient-to-r ${isPrimary ? 'from-blue-50 to-indigo-50 border-2 border-blue-300' : 'from-gray-50 to-gray-100 border border-gray-300'} rounded-xl p-4 mb-3">
                                <div class="flex items-start justify-between mb-3">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2 mb-2">
                                            <i class="fas fa-hospital text-blue-600 text-lg"></i>
                                            <h5 class="font-bold text-gray-800">${clinic.name || 'Unnamed Clinic'}</h5>
                                            ${isPrimary ? '<span class="bg-yellow-400 text-yellow-900 text-xs px-2 py-1 rounded-full font-semibold"><i class="fas fa-star mr-1"></i>Primary</span>' : ''}
                                        </div>
                                        <div class="space-y-1 text-sm text-gray-700">
                                            <p><i class="fas fa-map-marker-alt w-4 text-gray-500"></i> ${clinic.address || 'No address'}</p>
                                            <p><i class="fas fa-phone w-4 text-gray-500"></i> ${clinic.phone || 'No phone'}</p>
                                            <p><i class="fas fa-envelope w-4 text-gray-500"></i> ${clinic.email || 'No email'}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid grid-cols-3 gap-2 mt-3 pt-3 border-t border-gray-300">
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-blue-600">${clinicApptCount}</div>
                                        <div class="text-xs text-gray-600">Appointments</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-green-600">${clinicCompletedCount}</div>
                                        <div class="text-xs text-gray-600">Completed</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-purple-600">${clinicServicesCount}</div>
                                        <div class="text-xs text-gray-600">Services</div>
                                    </div>
                                </div>
                                <div class="mt-3 pt-3 border-t border-gray-300">
                                    <p class="text-xs text-gray-500"><strong>Clinic ID:</strong> <code class="bg-gray-200 px-1 rounded">${clinic.id}</code></p>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    clinicCardsHTML = '<p class="text-gray-500 text-sm">No clinics assigned</p>';
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6 max-h-screen overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold text-2xl">
                                    ${doctor.name ? doctor.name.charAt(0).toUpperCase() : 'D'}
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-800">${doctor.name || 'Doctor'}</h3>
                                    <p class="text-sm text-gray-600">${doctor.specialty || 'General Dentist'}</p>
                                </div>
                            </div>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Status Badge -->
                        <div class="mb-6">
                            ${doctor.active 
                                ? '<span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>Active</span>'
                                : '<span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-ban mr-1"></i>Inactive</span>'}
                        </div>
                        
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600">${totalAppointments}</div>
                                <div class="text-xs text-gray-600">Total Appointments</div>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600">${completedAppointments}</div>
                                <div class="text-xs text-gray-600">Completed</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-purple-600">${servicesCount}</div>
                                <div class="text-xs text-gray-600">Services Offered</div>
                            </div>
                        </div>
                        
                        <!-- Details Grid -->
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-user text-blue-600 mr-2"></i>Personal Information
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Full Name:</strong> ${doctor.name || 'N/A'}</p>
                                    <p><strong>Email:</strong> ${doctor.email || 'N/A'}</p>
                                    <p><strong>Phone:</strong> ${doctor.phone || 'N/A'}</p>
                                    <p><strong>Specialty:</strong> ${doctor.specialty || 'General Dentist'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-info-circle text-blue-600 mr-2"></i>Account Information
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>User ID:</strong> <code class="text-xs bg-gray-200 px-1 rounded">${doctor.id}</code></p>
                                    <p><strong>Role:</strong> Doctor</p>
                                    <p><strong>Created:</strong> ${doctor.createdAt ? new Date(doctor.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                                    <p><strong>Upcoming Appointments:</strong> ${upcomingAppointments}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-calendar text-blue-600 mr-2"></i>Schedule Settings
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Appointment Duration:</strong> ${doctor.appointmentDuration || 30} minutes</p>
                                    <p><strong>Buffer Time:</strong> ${doctor.bufferTime || 10} minutes</p>
                                    <p><strong>Weekly Schedule:</strong> ${doctor.weeklySchedule ? 'Configured' : 'Not set'}</p>
                                </div>
                            </div>
                            
                        </div>
                        
                        <!-- Clinic Assignments Section -->
                        <div class="mb-6">
                            <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-hospital text-blue-600 mr-2"></i>
                                Clinic Assignments 
                                <span class="ml-2 bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full font-semibold">
                                    ${clinicData.length} ${clinicData.length === 1 ? 'Clinic' : 'Clinics'}
                                </span>
                            </h4>
                            <div class="space-y-3">
                                ${clinicCardsHTML}
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <button onclick="resetDoctorPassword('${doctor.id}')" 
                                    class="bg-yellow-500 text-white px-6 py-3 rounded-lg hover:bg-yellow-600 transition font-semibold">
                                <i class="fas fa-key mr-2"></i>Reset Password
                            </button>
                            
                            <button onclick="toggleDoctorStatus('${doctor.id}', ${!doctor.active}); closeModal();" 
                                    class="bg-${doctor.active ? 'red' : 'green'}-500 text-white px-6 py-3 rounded-lg hover:bg-${doctor.active ? 'red' : 'green'}-600 transition font-semibold">
                                <i class="fas fa-${doctor.active ? 'ban' : 'check-circle'} mr-2"></i>${doctor.active ? 'Deactivate' : 'Activate'} Doctor
                            </button>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition font-semibold">
                            <i class="fas fa-times mr-2"></i>Close
                        </button>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
            } catch (error) {
                console.error('Error loading doctor details:', error);
                showToast('Error loading doctor details', 'error');
            }
        }
        
        async function viewAppointmentDetails(appointmentId) {
            try {
                const aptDoc = await db.collection('appointments').doc(appointmentId).get();
                if (!aptDoc.exists) {
                    showToast('Appointment not found', 'error');
                    return;
                }
                
                const apt = { id: aptDoc.id, ...aptDoc.data() };
                
                // Get clinic name
                let clinicName = 'N/A';
                if (apt.clinicId) {
                    const clinicDoc = await db.collection('clinics').doc(apt.clinicId).get();
                    if (clinicDoc.exists) {
                        clinicName = clinicDoc.data().name;
                    }
                }
                
                // Status colors
                const statusColors = {
                    'booked': 'bg-blue-100 text-blue-800',
                    'approve': 'bg-purple-100 text-purple-800',
                    'appointment': 'bg-green-100 text-green-800',
                    'missed': 'bg-orange-100 text-orange-800',
                    'cancelled': 'bg-red-100 text-red-800',
                    'completed': 'bg-gray-100 text-gray-800'
                };
                const statusColor = statusColors[apt.status] || 'bg-gray-100 text-gray-800';
                
                // Format notes
                let notesHTML = 'No notes';
                if (apt.notes) {
                    if (Array.isArray(apt.notes)) {
                        notesHTML = apt.notes.map(note => `<p class="mb-2"> ${note}</p>`).join('');
                    } else {
                        notesHTML = apt.notes;
                    }
                }
                
                // Calculate duration and end time
                let duration = apt.duration || 'N/A';
                let endTime = apt.endTime || 'N/A';
                
                if (apt.serviceId && apt.startTime && !apt.duration) {
                    // Try to get duration from service
                    try {
                        const serviceDoc = await db.collection('services').doc(apt.serviceId).get();
                        if (serviceDoc.exists) {
                            duration = serviceDoc.data().duration || 'N/A';
                        }
                    } catch (e) {
                        console.log('Could not fetch service duration');
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full p-6 max-h-screen overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h3 class="text-2xl font-bold text-gray-800">Appointment Details</h3>
                                <p class="text-sm text-gray-600">ID: ${apt.id}</p>
                            </div>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Status Badge -->
                        <div class="mb-6">
                            <span class="px-4 py-2 rounded-full text-sm font-semibold ${statusColor}">
                                ${apt.status ? apt.status.toUpperCase() : 'N/A'}
                            </span>
                        </div>
                        
                        <!-- Details Grid -->
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-user text-blue-600 mr-2"></i>Patient Information
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Name:</strong> ${apt.patientName || 'N/A'}</p>
                                    <p><strong>Email:</strong> ${apt.patientEmail || 'N/A'}</p>
                                    <p><strong>Phone:</strong> ${apt.patientPhone || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-user-md text-green-600 mr-2"></i>Doctor Information
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Name:</strong> ${apt.doctorName || 'N/A'}</p>
                                    <p><strong>Clinic:</strong> ${clinicName}</p>
                                </div>
                            </div>
                            
                            <div class="bg-purple-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-calendar text-purple-600 mr-2"></i>Appointment Schedule
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Date:</strong> ${apt.date || 'N/A'}</p>
                                    <p><strong>Start Time:</strong> ${apt.time || apt.startTime || apt.slot || 'N/A'}</p>
                                    <p><strong>End Time:</strong> ${endTime}</p>
                                    <p><strong>Duration:</strong> ${duration} ${duration !== 'N/A' ? 'minutes' : ''}</p>
                                </div>
                            </div>
                            
                            <div class="bg-yellow-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-tooth text-yellow-600 mr-2"></i>Service Information
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Service:</strong> ${apt.serviceName || apt.service || 'N/A'}</p>
                                    <p><strong>Price:</strong> ${apt.servicePrice ? `${apt.serviceCurrency || 'PHP'} ${apt.servicePrice}` : 'N/A'}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Notes Section -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-sticky-note text-gray-600 mr-2"></i>Notes
                            </h4>
                            <div class="text-sm text-gray-700">
                                ${notesHTML}
                            </div>
                        </div>
                        
                        <!-- Metadata -->
                        <div class="bg-gray-50 p-4 rounded-lg mb-6">
                            <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                <i class="fas fa-info-circle text-gray-600 mr-2"></i>Metadata
                            </h4>
                            <div class="space-y-2 text-sm text-gray-700">
                                <p><strong>Created:</strong> ${apt.createdAt ? new Date(apt.createdAt.toDate()).toLocaleString() : 'N/A'}</p>
                                <p><strong>Clinic ID:</strong> <code class="bg-gray-200 px-1 rounded text-xs">${apt.clinicId || 'N/A'}</code></p>
                                <p><strong>Doctor ID:</strong> <code class="bg-gray-200 px-1 rounded text-xs">${apt.userId || 'N/A'}</code></p>
                            </div>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition font-semibold">
                            <i class="fas fa-times mr-2"></i>Close
                        </button>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
            } catch (error) {
                console.error('Error loading appointment details:', error);
                showToast('Error loading appointment details', 'error');
            }
        }
        
        function resetDoctorPassword(doctorId) {
            showInputModal('Reset Password', 'Enter new password (min 6 characters)', 'Reset Password', async (newPassword) => {
                if (newPassword.length < 6) {
                    showToast('Password must be at least 6 characters', 'warning');
                    return;
                }
                
                try {
                    showLoading('Resetting password...');
                    
                    await db.collection('users').doc(doctorId).update({
                        password: newPassword,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    hideLoading();
                    showToast('Password reset successfully!', 'success');
                    showInfoModal('Password Reset', `Password has been reset to: <strong>${newPassword}</strong><br><br>Please share this with the doctor securely.`);
                } catch (error) {
                    hideLoading();
                    console.error('Error resetting password:', error);
                    showToast('Error resetting password', 'error');
                }
            });
        }
        
        function toggleDoctorStatus(doctorId, newStatus) {
            showConfirmModal(
                newStatus ? 'Activate Doctor' : 'Deactivate Doctor',
                `Are you sure you want to ${newStatus ? 'activate' : 'deactivate'} this doctor?`,
                async () => {
                    try {
                        await db.collection('users').doc(doctorId).update({
                            active: newStatus,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        showToast(`Doctor ${newStatus ? 'activated' : 'deactivated'} successfully`, 'success');
                        loadDoctors();
                    } catch (error) {
                        console.error('Error updating doctor status:', error);
                        showToast('Error updating doctor status', 'error');
                    }
                },
                newStatus ? 'Activate' : 'Deactivate',
                newStatus ? 'green' : 'red'
            );
        }
        
        async function viewStaffDetails(staffId) {
            try {
                const staffDoc = await db.collection('users').doc(staffId).get();
                if (!staffDoc.exists) {
                    showToast('Staff not found', 'error');
                    return;
                }
                
                const staff = { id: staffDoc.id, ...staffDoc.data() };
                
                // Get clinic name
                let clinicName = 'No clinic assigned';
                if (staff.clinicId) {
                    const clinicDoc = await db.collection('clinics').doc(staff.clinicId).get();
                    if (clinicDoc.exists) {
                        clinicName = clinicDoc.data().name;
                    }
                }
                
                // Get assigned doctors (support array)
                let assignedDoctorsList = [];
                if (staff.assignedDoctors && staff.assignedDoctors.length > 0) {
                    const doctorPromises = staff.assignedDoctors.map(id => db.collection('users').doc(id).get());
                    const doctorDocs = await Promise.all(doctorPromises);
                    assignedDoctorsList = doctorDocs
                        .filter(doc => doc.exists)
                        .map(doc => ({ id: doc.id, ...doc.data() }));
                }
                
                const assignedDoctorsHtml = assignedDoctorsList.length > 0
                    ? assignedDoctorsList.map(doc => `
                        <div class="flex items-center space-x-2 bg-blue-50 px-3 py-2 rounded-lg">
                            <i class="fas fa-user-md text-blue-600"></i>
                            <span class="text-gray-800 font-medium">${doc.name}</span>
                            <span class="text-xs text-gray-500">(${doc.specialty || 'General'})</span>
                        </div>
                    `).join('')
                    : '<p class="text-gray-500 text-sm">No doctors assigned</p>';
                
                // Get appointment stats for this staff's doctors
                let totalAppointments = 0;
                if (staff.assignedDoctors && staff.assignedDoctors.length > 0) {
                    for (const doctorId of staff.assignedDoctors) {
                        const aptsSnap = await db.collection('appointments')
                            .where('userId', '==', doctorId)
                            .get();
                        totalAppointments += aptsSnap.size;
                    }
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6 max-h-screen overflow-y-auto">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center space-x-3">
                                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center text-green-600 font-bold text-2xl">
                                    ${staff.name ? staff.name.charAt(0).toUpperCase() : 'S'}
                                </div>
                                <div>
                                    <h3 class="text-2xl font-bold text-gray-800">${staff.name || 'Staff'}</h3>
                                    <p class="text-sm text-gray-600">${staff.position || 'Staff Member'}</p>
                                </div>
                            </div>
                            <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 text-2xl">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Status Badge -->
                        <div class="mb-6">
                            ${staff.active 
                                ? '<span class="px-3 py-1 text-sm font-semibold rounded-full bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>Active</span>'
                                : '<span class="px-3 py-1 text-sm font-semibold rounded-full bg-red-100 text-red-800"><i class="fas fa-ban mr-1"></i>Inactive</span>'}
                        </div>
                        
                        <!-- Stats Cards -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-green-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-green-600">${assignedDoctorsList.length}</div>
                                <div class="text-xs text-gray-600">Assigned Doctors</div>
                            </div>
                            <div class="bg-blue-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-blue-600">${totalAppointments}</div>
                                <div class="text-xs text-gray-600">Total Appointments</div>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-purple-600">${clinicName !== 'No clinic assigned' ? '1' : '0'}</div>
                                <div class="text-xs text-gray-600">Clinic Assigned</div>
                            </div>
                        </div>
                        
                        <!-- Details Grid -->
                        <div class="grid md:grid-cols-2 gap-6 mb-6">
                            <div class="bg-green-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-user text-green-600 mr-2"></i>Personal Information
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Full Name:</strong> ${staff.name || 'N/A'}</p>
                                    <p><strong>Email:</strong> ${staff.email || 'N/A'}</p>
                                    <p><strong>Phone:</strong> ${staff.phone || 'N/A'}</p>
                                    <p><strong>Username:</strong> ${staff.username || 'N/A'}</p>
                                    <p><strong>Position:</strong> ${staff.position || 'Staff Member'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-hospital text-green-600 mr-2"></i>Clinic Assignment
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>Assigned Clinic:</strong> ${clinicName}</p>
                                    <p><strong>Clinic ID:</strong> ${staff.clinicId || 'N/A'}</p>
                                </div>
                            </div>
                            
                            <div class="col-span-2 bg-blue-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-user-md text-blue-600 mr-2"></i>Assigned Doctors (${assignedDoctorsList.length})
                                </h4>
                                <div class="grid grid-cols-2 gap-2">
                                    ${assignedDoctorsHtml}
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-info-circle text-green-600 mr-2"></i>Account Information
                                </h4>
                                <div class="space-y-2 text-sm">
                                    <p><strong>User ID:</strong> <code class="text-xs bg-gray-200 px-1 rounded">${staff.id}</code></p>
                                    <p><strong>Role:</strong> Staff</p>
                                    <p><strong>Created:</strong> ${staff.createdAt ? new Date(staff.createdAt.toDate()).toLocaleDateString() : 'N/A'}</p>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-bold text-gray-800 mb-3 flex items-center">
                                    <i class="fas fa-sticky-note text-green-600 mr-2"></i>Notes
                                </h4>
                                <div class="text-sm text-gray-700">
                                    ${staff.notes || '<span class="text-gray-400 italic">No notes</span>'}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <button onclick="resetStaffPassword('${staff.id}')" 
                                    class="bg-yellow-500 text-white px-6 py-3 rounded-lg hover:bg-yellow-600 transition font-semibold">
                                <i class="fas fa-key mr-2"></i>Reset Password
                            </button>
                            
                            <button onclick="toggleStaffStatus('${staff.id}', ${!staff.active}); closeModal();" 
                                    class="bg-${staff.active ? 'red' : 'green'}-500 text-white px-6 py-3 rounded-lg hover:bg-${staff.active ? 'red' : 'green'}-600 transition font-semibold">
                                <i class="fas fa-${staff.active ? 'ban' : 'check-circle'} mr-2"></i>${staff.active ? 'Deactivate' : 'Activate'} Staff
                            </button>
                        </div>
                        
                        <button onclick="closeModal()" class="w-full bg-gray-600 text-white px-6 py-3 rounded-lg hover:bg-gray-700 transition font-semibold">
                            <i class="fas fa-times mr-2"></i>Close
                        </button>
                    </div>
                `;
                document.getElementById('modal-container').appendChild(modal);
            } catch (error) {
                console.error('Error loading staff details:', error);
                showToast('Error loading staff details', 'error');
            }
        }
        
        function resetStaffPassword(staffId) {
            showInputModal('Reset Password', 'Enter new password (min 6 characters)', 'Reset Password', async (newPassword) => {
                if (newPassword.length < 6) {
                    showToast('Password must be at least 6 characters', 'warning');
                    return;
                }
                
                try {
                    showLoading('Resetting password...');
                    
                    await db.collection('users').doc(staffId).update({
                        password: newPassword,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    hideLoading();
                    showToast('Password reset successfully!', 'success');
                    showInfoModal('Password Reset', `Password has been reset to: <strong>${newPassword}</strong><br><br>Please share this with the staff securely.`);
                } catch (error) {
                    hideLoading();
                    console.error('Error resetting password:', error);
                    showToast('Error resetting password', 'error');
                }
            });
        }
        
        function toggleStaffStatus(staffId, newStatus) {
            showConfirmModal(
                newStatus ? 'Activate Staff' : 'Deactivate Staff',
                `Are you sure you want to ${newStatus ? 'activate' : 'deactivate'} this staff member?`,
                async () => {
                    try {
                        await db.collection('users').doc(staffId).update({
                            active: newStatus,
                            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        
                        showToast(`Staff ${newStatus ? 'activated' : 'deactivated'} successfully`, 'success');
                        loadStaff();
                    } catch (error) {
                        console.error('Error updating staff status:', error);
                        showToast('Error updating staff status', 'error');
                    }
                },
                newStatus ? 'Activate' : 'Deactivate',
                newStatus ? 'green' : 'red'
            );
        }
        
        // ========== HELPER FUNCTIONS ==========
        
        async function updateClinicFilters() {
            const clinicsSnap = await db.collection('clinics').where('active', '==', true).get();
            const clinics = clinicsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            const filterDoctors = document.getElementById('filter-clinic-doctors');
            const filterStaff = document.getElementById('filter-clinic-staff');
            const filterApt = document.getElementById('filter-clinic-apt');
            
            const options = clinics.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            
            if (filterDoctors) {
                filterDoctors.innerHTML = '<option value="">All Clinics</option>' + options;
            }
            if (filterStaff) {
                filterStaff.innerHTML = '<option value="">All Clinics</option>' + options;
            }
            if (filterApt) {
                filterApt.innerHTML = '<option value="">All Clinics</option>' + options;
            }
        }
        
        // Initialize - Wait for Firebase Auth to be ready
        auth.onAuthStateChanged(async (user) => {
            console.log('Auth state changed:', user ? 'User logged in' : 'No user');
            
            // Mark that auth has been initialized
            if (!authInitialized) {
                authInitialized = true;
                
                if (!user) {
                    // No Firebase user, redirect to login
                    console.log('No Firebase user found, redirecting to login');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'superadmin-login.html';
                    return;
                }
                
                console.log('Firebase user found:', user.uid);
                
                // Verify user role from Firestore
                try {
                    const userDoc = await db.collection('users').doc(user.uid).get();
                    console.log('User doc exists:', userDoc.exists);
                    
                    if (!userDoc.exists) {
                        console.error('User document not found in Firestore');
                        await auth.signOut();
                        localStorage.removeItem('currentUser');
                        window.location.href = 'superadmin-login.html';
                        return;
                    }
                    
                    const userData = userDoc.data();
                    console.log('User role:', userData.role);
                    
                    if (userData.role !== 'superadmin') {
                        console.error('User is not a superadmin');
                        await auth.signOut();
                        localStorage.removeItem('currentUser');
                        window.location.href = 'superadmin-login.html';
                        return;
                    }
                    
                    // Auth is valid, check localStorage and initialize
                    console.log('Auth validated, initializing dashboard');
                    
                    // Hide auth loading overlay
                    document.getElementById('auth-loading').style.display = 'none';
                    
                    if (checkAuth()) {
                        // Restore last active section if exists
                        const lastSection = localStorage.getItem('lastActiveSection');
                        if (lastSection && lastSection !== 'dashboard') {
                            localStorage.removeItem('lastActiveSection');
                            // Simulate click on the nav button
                            setTimeout(() => {
                                const navBtn = document.querySelector(`[onclick*="'${lastSection}'"]`);
                                if (navBtn) {
                                    navBtn.click();
                                } else {
                                    loadDashboard();
                                }
                            }, 100);
                        } else {
                            loadDashboard();
                        }
                    }
                } catch (error) {
                    console.error('Auth state check error:', error);
                    localStorage.removeItem('currentUser');
                    window.location.href = 'superadmin-login.html';
                }
            } else {
                // Subsequent auth state changes (e.g., user logged out elsewhere)
                console.log('Subsequent auth state change');
                if (!user) {
                    console.log('User logged out, redirecting');
                    localStorage.removeItem('currentUser');
                    window.location.href = 'superadmin-login.html';
                }
            }
        });
    </script>
</body>
</html>
